<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_1hj4kq9" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="3.2.1">
  <bpmn:process id="Process_MSO" name="MS Orchestration" isExecutable="true" camunda:candidateStarterGroups="camunda-developer">
    <bpmn:startEvent id="StartEvent_1">
      <bpmn:extensionElements>
        <camunda:formData>
          <camunda:formField id="token" label="Token" type="string" />
          <camunda:formField id="quantity" label="Quantity" type="long" />
        </camunda:formData>
      </bpmn:extensionElements>
      <bpmn:outgoing>SequenceFlow_1l1nz42</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:serviceTask id="Task_08gjbkd" name="Get Credit Card">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="headers">
              <camunda:map>
                <camunda:entry key="X-OP-APIKey">cf39d27eef08406bb31b585eed983df5</camunda:entry>
                <camunda:entry key="Content-Type">application/json</camunda:entry>
                <camunda:entry key="Accept">application/json</camunda:entry>
              </camunda:map>
            </camunda:inputParameter>
            <camunda:inputParameter name="method">GET</camunda:inputParameter>
            <camunda:inputParameter name="url">https://development.onesaitplatform.com/api-manager/server/api/v1/tokenToCard/convert/${token}</camunda:inputParameter>
            <camunda:outputParameter name="cc">
              <camunda:script scriptFormat="JavaScript">var isValid = S(response).hasProp("cc");
if(isValid){
S(response).prop("cc").stringValue()
}else{
S(response)
}</camunda:script>
            </camunda:outputParameter>
            <camunda:outputParameter name="ccValid">
              <camunda:script scriptFormat="JavaScript">S(response).hasProp("cc")</camunda:script>
            </camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_1l1nz42</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_0kbpa5a</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="SequenceFlow_1l1nz42" sourceRef="StartEvent_1" targetRef="Task_08gjbkd" />
    <bpmn:exclusiveGateway id="ExclusiveGateway_14hcin0" name="Token validity">
      <bpmn:incoming>SequenceFlow_0kbpa5a</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_0uuhgrn</bpmn:outgoing>
      <bpmn:outgoing>SequenceFlow_1la98k2</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="SequenceFlow_0kbpa5a" sourceRef="Task_08gjbkd" targetRef="ExclusiveGateway_14hcin0" />
    <bpmn:sequenceFlow id="SequenceFlow_0uuhgrn" name="Valid Token" sourceRef="ExclusiveGateway_14hcin0" targetRef="ServiceTask_1m1pndz">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${ccValid}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="SequenceFlow_1la98k2" name="Not Valid Token" sourceRef="ExclusiveGateway_14hcin0" targetRef="Erorr_final">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${!ccValid}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:exclusiveGateway id="ExclusiveGateway_1bazx33" name="Balance Check">
      <bpmn:incoming>SequenceFlow_1713htb</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_152v9gt</bpmn:outgoing>
      <bpmn:outgoing>SequenceFlow_18q5fpg</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="SequenceFlow_152v9gt" name="Proceed" sourceRef="ExclusiveGateway_1bazx33" targetRef="ServiceTask_15ff6o6">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${hasBalance}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="SequenceFlow_18q5fpg" name="Not enough balance" sourceRef="ExclusiveGateway_1bazx33" targetRef="Erorr_final">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${!hasBalance}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:endEvent id="EndEvent_00961sr" name="OK&#10;&#10;">
      <bpmn:incoming>SequenceFlow_1xr086b</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:serviceTask id="ServiceTask_1m1pndz" name="Get Balance">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="headers">
              <camunda:map>
                <camunda:entry key="X-OP-APIKey">cf39d27eef08406bb31b585eed983df5</camunda:entry>
                <camunda:entry key="Content-Type">application/json</camunda:entry>
                <camunda:entry key="Accept">application/json</camunda:entry>
              </camunda:map>
            </camunda:inputParameter>
            <camunda:inputParameter name="method">GET</camunda:inputParameter>
            <camunda:inputParameter name="url">https://development.onesaitplatform.com/api-manager/server/api/v1/credit-cards/verify/${cc}/${quantity}</camunda:inputParameter>
            <camunda:outputParameter name="balance">
              <camunda:script scriptFormat="JavaScript">var hasBalance = S(response).hasProp("balance");
if(hasBalance){
S(response).prop("balance")
}else{
S(response)
}</camunda:script>
            </camunda:outputParameter>
            <camunda:outputParameter name="hasBalance">
              <camunda:script scriptFormat="JavaScript">S(response).hasProp("balance")</camunda:script>
            </camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_0uuhgrn</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_1713htb</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="SequenceFlow_1713htb" sourceRef="ServiceTask_1m1pndz" targetRef="ExclusiveGateway_1bazx33" />
    <bpmn:serviceTask id="ServiceTask_15ff6o6" name="POST TX">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="headers">
              <camunda:map>
                <camunda:entry key="X-OP-APIKey">cf39d27eef08406bb31b585eed983df5</camunda:entry>
                <camunda:entry key="Content-Type">application/json</camunda:entry>
                <camunda:entry key="Accept">application/json</camunda:entry>
              </camunda:map>
            </camunda:inputParameter>
            <camunda:inputParameter name="method">POST</camunda:inputParameter>
            <camunda:inputParameter name="url">https://development.onesaitplatform.com/api-manager/server/api/v1/transactions</camunda:inputParameter>
            <camunda:inputParameter name="payload">
              <camunda:script scriptFormat="JavaScript">var payload = {
  "transactionId":Math.round(Math.random()*1000),
  "charged": quantity,
 "cardNumber":cc
}

JSON.stringify(payload);</camunda:script>
            </camunda:inputParameter>
            <camunda:outputParameter name="operationResult">Payment Accepted</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_152v9gt</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_1xr086b</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="SequenceFlow_1xr086b" sourceRef="ServiceTask_15ff6o6" targetRef="EndEvent_00961sr" />
    <bpmn:endEvent id="Erorr_final" name="KO&#10;&#10;">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:inputParameter name="operationResult">Payment refused</camunda:inputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_18q5fpg</bpmn:incoming>
      <bpmn:incoming>SequenceFlow_1la98k2</bpmn:incoming>
      <bpmn:errorEventDefinition errorRef="Error_04pyywz" />
    </bpmn:endEvent>
  </bpmn:process>
  <bpmn:error id="Error_04pyywz" name="Payment refused" errorCode="500" />
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_MSO">
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
        <dc:Bounds x="156" y="253" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_0mvwqcl_di" bpmnElement="Task_08gjbkd">
        <dc:Bounds x="284" y="231" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1l1nz42_di" bpmnElement="SequenceFlow_1l1nz42">
        <di:waypoint x="192" y="271" />
        <di:waypoint x="284" y="271" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ExclusiveGateway_14hcin0_di" bpmnElement="ExclusiveGateway_14hcin0" isMarkerVisible="true">
        <dc:Bounds x="439" y="246" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="496" y="283" width="67" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0kbpa5a_di" bpmnElement="SequenceFlow_0kbpa5a">
        <di:waypoint x="384" y="271" />
        <di:waypoint x="439" y="271" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0uuhgrn_di" bpmnElement="SequenceFlow_0uuhgrn">
        <di:waypoint x="464" y="246" />
        <di:waypoint x="464" y="181" />
        <di:waypoint x="530" y="181" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="463" y="144" width="57" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1la98k2_di" bpmnElement="SequenceFlow_1la98k2">
        <di:waypoint x="464" y="296" />
        <di:waypoint x="464" y="391" />
        <di:waypoint x="686" y="391" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="545" y="403" width="77" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ExclusiveGateway_1bazx33_di" bpmnElement="ExclusiveGateway_1bazx33" isMarkerVisible="true">
        <dc:Bounds x="679" y="156" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="733" y="193" width="74" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_152v9gt_di" bpmnElement="SequenceFlow_152v9gt">
        <di:waypoint x="704" y="156" />
        <di:waypoint x="704" y="121" />
        <di:waypoint x="790" y="121" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="641" y="132" width="41" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_18q5fpg_di" bpmnElement="SequenceFlow_18q5fpg">
        <di:waypoint x="704" y="206" />
        <di:waypoint x="704" y="373" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="731" y="276" width="57" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="EndEvent_00961sr_di" bpmnElement="EndEvent_00961sr">
        <dc:Bounds x="956" y="103" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="966" y="146" width="16" height="40" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_1m1pndz_di" bpmnElement="ServiceTask_1m1pndz">
        <dc:Bounds x="530" y="141" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1713htb_di" bpmnElement="SequenceFlow_1713htb">
        <di:waypoint x="630" y="181" />
        <di:waypoint x="679" y="181" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="ServiceTask_15ff6o6_di" bpmnElement="ServiceTask_15ff6o6">
        <dc:Bounds x="790" y="81" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_1xr086b_di" bpmnElement="SequenceFlow_1xr086b">
        <di:waypoint x="890" y="121" />
        <di:waypoint x="956" y="121" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="EndEvent_0lgi8f0_di" bpmnElement="Erorr_final">
        <dc:Bounds x="686" y="373" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="696" y="416" width="16" height="40" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
