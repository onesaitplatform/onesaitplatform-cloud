<!--

    Copyright Indra Soluciones Tecnologías de la Información, S.L.U.
    2013-2019 SPAIN

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
         http://www.apache.org/licenses/LICENSE-2.0
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<html xmlns:th="http://www.thymeleaf.org" xmlns:dt="http://www.thymeleaf.org/dandelion/datatables" th:with="lang=${#locale.language}" th:lang="${lang}">
	<head>
	    <meta name="_csrf" th:content="${_csrf.token}"/>
		<meta name="_csrf_header"  th:content="${_csrf.headerName}"/>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
		<meta http-equiv="Content-Language" th:content="${lang}"/>
		<title th:text="#{name.app}"/>
		
		<!-- STYLE SHEETS -->
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/bootstrap.min.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/components.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/plugins.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/layout.css}"/>
		<!-- THEME -->
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/webjars/sofia2_theme/css/sofia2.css}"/>
		
		<!-- PLUGINS STYLE SHEETS -->
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/datatable/datatables.bootstrap.css}"/>	
	</head>	
	
	<!-- page-sidebar-closed to start page with collapsed menu -->
	<body class="page-header-fixed  page-content-white page-sidebar-closed">

	<!-- MAIN PAGE WRAPPER -->
	<div class="page-wrapper">
	
		<!-- BEGIN HEADER INCLUDE -->
		<div th:include="fragments/header::#headerFragment" class="page-header navbar navbar-fixed-top"></div>
		<!-- END HEADER -->
		
		<!-- BEGIN HEADER AND CONTENT DIVIDER -->
		<div class="clearfix"> </div>		
			
		<!-- BEGIN SIDEBAR -->
		<div th:include="fragments/menu::#menuFragment" class="page-sidebar-wrapper"></div>
		<!-- END SIDEBAR -->
		
				
		<!-- BEGIN CONTENT -->
		<div class="page-content-wrapper">
			
			<!-- BEGIN CONTENT BODY -->
			<div class="page-content">
				
				<!-- BEGIN PAGE HEADER-->
				
				<!-- BEGIN PAGE BAR AND BREADCRUM -->
				<div class="page-bar margin-bottom-20">
					<ul class="page-breadcrumb">
						<li><a th:href="@{/}">Home</a><i class="fa fa-angle-right"></i></li>						
						<li><span th:text="#{dashboards.my}">My Dashboards</span></li>
					</ul>						
				</div>
				<!-- END PAGE BAR -->
				
				<!-- BEGIN PAGE TITLE-->
				<h1 class="page-title hide "><span th:text="#{dashboards.my}">My Dashboards </span></h1>
				<!-- END PAGE TITLE-->			
				
				<!-- MAIN ROW -->
				<div class="row">
					<div class="col-md-12">					
						<div class="portlet light">
							<div class="portlet-title">
								<div class="caption">									
									<span class="caption-subject" th:text="#{dashboards.my}"> My Dashboard </span>									
								</div>									
								<div class="tools hide">
									<a href="" class="collapse" data-original-title="" title=""> </a>
									<a href="" class="fullscreen" data-original-title="" title=""> </a>
								</div>								
								<div class="actions margin-right-20">
									<div class="btn-group">										
										<button id="search-toggle" type="button" class="btn btn-circle btn-outline blue" onclick="$('#searchFilter').toggleClass('hide')"><span th:text="#{gen.search}"> Search </span></button>																			
										<button sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" type="button" class="btn btn-circle btn-outline blue" id="createDashboardButton" onclick="location.href='/controlpanel/gadgets/list'"><span th:text="#{gadgets.listGadgets}">Gadgets</span></button>										
										<button sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" type="button" class="btn btn-circle btn-outline blue" id="createDashboardButton" onclick="location.href='/controlpanel/datasources/list'"><span th:text="#{datasources.listDatasources}">Datasources </span></button>
										<button sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" type="button" class="btn btn-circle btn-outline btn-primary" onclick="javascript:showImportDashboardDialog()"><span th:text="#{dashboards.importdashboard}">Import Dashboard</span></button>										
										<button sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" type="button" class="btn btn-circle btn-outline btn-primary" id="createDashboardButton" onclick="location.href='/controlpanel/dashboards/create'"><span th:text="#{dashboards.create}">New Dashboard</span></button>
										<button sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" type="button" class="btn btn-circle btn-outline btn-primary" id="createDashboardButton" onclick="location.href='/controlpanel/dashboards/createsynoptic'"><span th:text="#{dashboards.create.synoptic}">New Synoptic</span></button>
									</div>										
								</div>
							</div>
							<div class="portlet-body" style="display: block; height: auto;">
								
								<div class="row">									
									<div id="searchFilter"  class="col-md-12 hide">
									<!-- SEARCH FORM -->
										<form id="form_dashboard" class="" role="form" method="get">								
											<div class="form-body " style="border-bottom: 1px solid #eef1f5;">
												<div class="row">
													<div class="col-md-4 col-xs-12">
														<div class="form-group">															
															<div class="input-group">
																<span class="input-group-addon">
																	<i class="fa fa-tag font-grey-mint"></i>
																</span>															
																<input id="name" th:placeholder="#{gen.name}" name="name" class="form-control" type="text" maxlength="50" value=""/>
															</div>
														</div>
													</div>
													<div class="col-md-4 col-xs-12">
														<div class="form-group">															
															<div class="input-group">
																<span class="input-group-addon">
																	<i class="fa fa-tag font-grey-mint"></i>
																</span>
																<select class="form-control" id="type" name="type" >														 
																	<option value="" text="" selected="selected"></option>
																	<option value="DASHBOARD" th:text="#{dashboards.list.dashboard}"></option>
																	<option value="SYNOPTIC" th:text="#{dashboards.list.synoptic}"></option>
																</select>
															</div>
														</div>
													</div>
													<div class="col-md-4 col-xs-12">
														<div class="btn-group">
															<button type="button" id="search_dashboard" name="search_dashboard" th:title="#{gen.search}" th:value="#{dashboard_search_button_form}" value="Search" class="btn btn-sm btn-circle btn-outline blue" th:text="#{gen.search}">Search </button>
															<button type="button" id="reset_dashboard" name="reset_dashboard" value="Reset" class="btn btn-sm btn-circle btn-outline blue" title="Reset"><i class="la la-refresh"></i>&nbsp;</button>													
														</div>
													</div>
												</div>
											</div>												
										<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /></form>								
									</div>
									<!-- DASHBOARD LIST -->
									<div class="col-md-12">	
																			
										<div id="contenedor-tabla-outside" class="contiene margin-bottom-30">																						
											<div>
											<!-- TABLE COLUMNS CONTAINER SHOW/HIDE -->
												<div id="dataTable-vis-toggle" class="btn-group margin-left-10 hide pull-right">
													<a href="javascript:;" data-toggle="dropdown" aria-expanded="false" class="btn btn-square btn-sm btn-default ">
														<span th:text="#{gen.columns}"></span> <i class="fa fa-angle-down"></i>
													</a>
													<div id="column_toggler" class="dropdown-menu hold-on-click dropdown-checkboxes pull-right">
														<label class="toggle-vis" data-column="0" th:text="#{gen.name}"> Name</label>
														<label class="toggle-vis" data-column="1" th:text="#{gen.owner}"> Owner</label>
														<label class="toggle-vis" data-column="2" th:text="#{gen.description}"> Description</label>
														<label class="toggle-vis" data-column="3" th:text="#{gadgets.type}"> Type</label>
														<label class="toggle-vis" data-column="4" th:text="#{gen.public}"> Public</label>														
														<label class="toggle-vis" data-column="5" th:text="#{gen.created}"> Created At</label>
														<label class="toggle-vis" data-column="6" th:text="#{gen.updated}"> Updated At</label>
														<label class="toggle-vis" data-column="7"  >ID</label>
														<label class="toggle-vis" data-column="8" th:text="#{gen.options}"> Options</label>															
													</div>
												</div>			
												<!-- DATATABLE DANDELION CONF. -->												
												<table id="dashboards" class="table table-hover table-striped" dt:table="true" dt:paginationtype="full_numbers">
													<thead>
														<tr class="cabecera-tabla">
															<th class="titulo-columnas" th:text="#{gen.name}">Name</th>
															<th class="titulo-columnas text-center" ><span th:text="#{gen.owner}" >Owner</span></th>
															<th class="titulo-columnas" th:text="#{gen.description}">Description</th>
															<th class="titulo-columnas" th:text="#{gadgets.type}">Type</th>
															<!--  <th class="titulo-columnas text-center" th:text="#{gen.active}">Active</th> -->	
															<th class="titulo-columnas text-center" th:text="#{gen.public}">Public</th>															
															<th class="titulo-columnas text-center" ><span th:text="#{gen.created}"> Created At </span></th>
															<th class="titulo-columnas text-center" ><span th:text="#{gen.updated}"> Updated At </span></th>
															<th class="titulo-columnas text-center" ><span > ID </span></th>
															<th class="titulo-columnas text-center" dt:sortable="false"><span th:text="#{gen.options}"> Options</span></th>
														</tr>
													</thead>
													<tbody th:remove="all-but-first">
														<tr th:each="dashboard : ${dashboards}" pages:paginate="10">
															<!-- IDENTIFICATION/NAME -->
															<td class="text-left" th:text="${dashboard.identification}"></td>															
															<!-- USER -->
															<td class="text-center " th:text="${dashboard.user.userId}"></td>
															<!-- DESCRIPTION -->
															<td class="text-left text-truncate-sm" th:title="${dashboard.description}" th:text="${dashboard.description}"></td>
															<!-- TYPE -->
															<td class="text-center"  th:if="${dashboard.type != null}  "><i   th:title="#{dashboards.list.synoptic}" class="fa fa-th-large font-hg font-blue-hoki tooltips"></i></td>
															<td class="text-center"  th:if="${dashboard.type == null}  "><i   th:title="#{dashboards.list.dashboard}" class="fa fa-table font-hg font-blue-hoki tooltips"></i></td>
															
															<!-- PUBLIC -->
															<td class="text-center" th:if="${dashboard.public}"><span th:text="1" style="display:none" ></span><i class="la la-check-circle-o text-success  font-hg"></i></td>
															<td class="text-center" th:if="${!dashboard.public}"><span th:text="0" style="display:none" ></span><i class="la la-times-circle-o text-danger  font-hg"></i></td>
															<!-- DATE --> 
			 												<td class="text-center" th:if="${dashboard.createdAt!=null}"><span th:text="${#dates.format(dashboard.createdAt,'YYYY/MM/dd')}" style="display:none" ></span><span th:text="${#dates.format(dashboard.createdAt,'dd/MM/YYYY')}" ></span></td>
															<td class="text-center" th:if="${dashboard.createdAt==null}" th:text="'---'"></td>
															<!-- UPDATE --> 
			 												<td class="text-center" th:if="${dashboard.updatedAt!=null}"><span th:text="${#dates.format(dashboard.updatedAt,'YYYY/MM/dd')}" style="display:none" ></span><span th:text="${#dates.format(dashboard.updatedAt,'dd/MM/YYYY')}" ></span></td>
															<td class="text-center" th:if="${dashboard.updatedAt==null}" th:text="'---'"></td>
															<td class="text-center " th:text="${dashboard.id}"></td>
															<!-- OPTIONS -->
															<td class="icon" style="white-space: nowrap">
																<div class="grupo-iconos text-center">
																	<!-- VIEW -->																																																					
																	<a  class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" th:title="#{gen.view}" th:href="'/controlpanel/dashboards/view/'+@{${dashboard.id}}"><i class="la la-eye font-hg"></i></a>
																	
																	<!-- Full EDIT -->																	
																	<a  sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" th:if="${dashboard.userAccessType=='EDIT'}" class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" data-placement="bottom" th:title="#{gen.edit}" th:href="'/controlpanel/dashboards/editfull/'+@{${dashboard.id}(form)}+ '='"><i class="la la-book font-hg"></i></a>
																	
																	<!-- EDIT ACCESS-->
																	<span sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" th:if="${dashboard.userAccessType=='EDIT'}" class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" data-container="body" data-placement="bottom" th:title="#{dashboards.auth.title} " th:data-original-title="#{dashboards.auth.title} " th:onclick="'javascript:navigateUrl(\'' + @{|/dashboards/dashboardconf/${dashboard.id}/|} + '\');'"><i class="la la-cog font-hg"></i></span>
																	
																	<!-- CLONE-->
																	<span th:title="#{dashboards.clone}" class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" th:onclick="'javascript:cloneDashboardDialog(\''+${dashboard.id}+ '\',\'' +${dashboard.identification}+'\');'"><i class="la la-clone font-hg"></i></span>
																	
																	<!-- URL -->
																	<span  class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" data-container="body" data-placement="bottom" title="URL Dashboard" data-original-title="URL Dashboard" th:onclick="'javascript:showDashboardURLDialog(\'' + @{|/dashboards/view/${dashboard.id}} + '\');'"><i class="la la-link font-hg"></i></span>
																
																    <!-- DOWNLOAD -->																   
																    <a th:title="#{dashboards.download}" class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" th:alt="#{dashboards.download}" th:if="${dashboard.userAccessType=='EDIT'}"  target="_blank" th:href="'/controlpanel/dashboards/exportDashboard/' +  ${dashboard.id}"><i class="la la-download font-hg"></i></a>
																    
																	<!-- IMPORT -->
																	<span sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" th:if="${dashboard.userAccessType=='EDIT'}"  class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" data-container="body" data-placement="bottom" th:title="#{dashboards.import}" data-original-title="Import" th:onclick="'javascript:showImportDashboardTableDialog(\'' + ${dashboard.identification} + '\');'"><i class="la la-upload font-hg"></i></span>
																    
																    
																    <!-- EDIT DASHBOARD JSON-->
																	<span sec:authorize="hasAuthority('ROLE_ADMINISTRATOR')"  class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" data-container="body" data-placement="bottom" th:title="#{dashboards.edit.model.json.tooltip} " th:data-original-title="#{dashboards.edit.model.json.tooltip} " th:onclick="'javascript:navigateUrl(\'' + @{|/dashboards/edit/${dashboard.id}/|} + '\');'"><i class="la la-edit font-hg"></i></span>																	
																
																    <!-- DELETE -->
																    <span sec:authorize="hasAuthority('ROLE_ADMINISTRATOR') or hasAuthority('ROLE_DEVELOPER') or hasAuthority('ROLE_DATASCIENTIST')" th:if="${dashboard.userAccessType=='EDIT'}" class="btn btn-xs btn-no-border btn-circle btn-outline blue tooltips" data-container="body" data-placement="bottom" th:title="#{gen.deleteBtn} " th:data-original-title="#{gen.deleteBtn} " th:onclick="'deleteDashboardConfirmation(\''+${dashboard.id}+'\');'"><i class="la la-trash font-hg"></i></span>
																</div>
															</td>
														</tr>
													</tbody>
												</table>
												
																				
											</div>
										</div>											
									</div>
								</div>
								<!-- AUXILIAR FORM TO DELETE DATASOURCE -->
								<form id="delete_dashboard_form" class="delete-dashboard hide" method="post">
									<input type="hidden" name="_method" value="DELETE"/>
									<input type="hidden" id="delete-id" name="id"/>
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /></form>	
							</div>
						</div><!-- END PORTLET BASIC LIGHT -->							
					</div><!-- END COL-12 -->						
				</div><!-- END MAIN ROW -->				
			</div><!-- END CONTENT BODY -->
		</div><!-- END CONTENT page-content-wrapper -->		
	</div>
	<!-- END MAIN PAGE WRAPPER -->
	
	<!-- FOOTER-INCLUDE -->
	<footer th:include="fragments/footer::#footerFragment" class="page-footer"> </footer>	
	
	<!-- CORE CONTROLLERS -->
	<script th:src="@{/static/js/app.js}"></script>
	<script th:src="@{/static/js/layout.js}"></script>
	
	<!-- PLUGINS -->
	<script th:src="@{/static/vendor/jquery/jquery.dataTables.min.js}"></script>
	<script th:src="@{/static/vendor/datatable/datatables.bootstrap.js}"></script>	
	<script th:src="@{/static/vendor/jquery/jquery.autocomplete.js}"></script>
	

	
	
	
	
	<script type="text/javascript" th:inline="javascript">	
	
	// TEMPLATE SEARCH FORM.
	var sname = [[${param.name}]] || '';
	var stype = [[${param.type}]] || '';
	var cloneTitle = [[#{dashboards.cloneText}]];
	var Close = [[#{gen.closeBtn}]];
	var CloneFail = [[#{dashboards.cloneFail}]];
	var MinLen = [[#{dashboards.minLen}]];
	
	sname ? $('#name').val(sname) : sname = '';
	stype ? $('#type').val(stype) : stype = '';
	console.log('SEARCHING ... [ Name: ' + sname + ' Type: ' + stype + ']');
	if (( sname != '') || (stype != '')) { $('#search-toggle').trigger('click'); }
	
	// DATATABLES LANGUAJE FROM PROPERTIES.
	datatable_lang = [[#{datatables_lang}]];	
	var languageJson = JSON.parse(datatable_lang);
	if ( languageJson ){ $.extend( true, $.fn.dataTable.defaults, { language: languageJson }); }

	</script>
	
	<script type="text/javascript"  th:inline="javascript">	
	//<![CDATA[
	var optionName = 'DASHBOARDS';
	
	var cloneDashboardDialog = function(dashboardId, identification){
		$.confirm({
			icon: 'fas fa-chart-pie',
			title: cloneTitle,
			theme: 'light',
			columnClass: 'medium',
			content: "<input class='col-md-12 form-control' type=text id='cloneIdentification' placeholder='"+MinLen+"'"+"></input>",
			draggable: true,
			dragWindowGap: 100,
			backgroundDismiss: true,
			closeIcon: true,
			buttons: {
				close: {
					text: Close,
					btnClass: 'btn btn-sm btn-circle btn-outline blue',
					action: function (){} //GENERIC CLOSE.		
				},
				Ok: {
					text: "Ok",
					btnClass: 'btn btn-sm btn-circle btn-outline btn-primary',
					action: function(){ 
						if($("#cloneIdentification").val()=="" || !$("#cloneIdentification").val() ||
							$("#cloneIdentification").val().length < 5){
			                cloneFail();
						}
						else {$.post(
								"/controlpanel/dashboards/clone", 
								{dashboardId : dashboardId, identification : $("#cloneIdentification").val()}
							).success(function(){
								navigateUrl("/controlpanel/dashboards/list")
								}
							).fail(
								function(e){									
									console.log("Error cloning dashboard, message detail: " + e.responseText);
									cloneFail();
								}
							)}
					}											
				}					
			}
		});
	}	
	
	var cloneFail = function (){
		$.alert({
			icon: 'la la-exclamation',
			title : "Fail",
			type : 'red',
			theme : 'light',
			content : CloneFail,
			buttons: {
				Ok: {
					text: "Ok",
					btnClass: 'btn btn-sm btn-outline btn-circle btn-primary',
					action: function (){}		
					}
				},
			})
	}
	
	var showDashboardURLDialog = function(url){
		
		var tenant =[[${tenant}]];
		var vertical = [[${vertical}]];
		
		if(vertical != null){
			url = url + '?vertical='+vertical+'&tenant='+tenant;
		}
		var editUrl = url.replace("/view/", "/editfull/");
		var viewIframUrl = url.replace("/view/", "/viewiframe/");
		var editIframUrl = url.replace("/view/", "/editfulliframe/");
		
		var messageInfo = [[#{dashboards.url.info}]]
		var messageCopied = [[#{dashboards.url.copied}]];
		
		var messageView = [[#{dashboards.url.view}]];
		var messageEdit = [[#{dashboards.url.edit}]];
		var messageViewIframe = [[#{dashboards.url.view.embedded}]];
		var messageEditIframe = [[#{dashboards.url.edit.embedded}]];
		
		$.confirm({
			icon: 'fas fa-chart-pie',
			title: "URL Dashboard",
			theme: 'light',
			columnClass: 'medium',
			content:`	
				<div class="alert alert-info alert-dismissable">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true"></button>
						<i class="fa fa-info-circle"></i> 
							<span>${messageInfo}</span>			
						</div>
						<div id="infoCopied" class="alert alert-success display-hide">
							<button class="close" data-close="alert"></button> <span >${messageCopied}</span>
						</div>
						<div><label>${messageView}</label>
						<input class="col-md-12 form-control" readonly="readonly" value="${window.location.origin}${url}" onclick=" this.select();document.execCommand('copy'); $('#infoCopied').show();" type="text"/>						
						</div>
						<div><label>${messageEdit}</label>
						<input class="col-md-12 form-control" readonly="readonly" value="${window.location.origin}${editUrl}" onclick=" this.select();document.execCommand('copy'); $('#infoCopied').show();" type="text"/>						
						</div>
						<div><label>${messageViewIframe}</label>
						<input class="col-md-12 form-control" readonly="readonly" value="${window.location.origin}${viewIframUrl}" onclick=" this.select();document.execCommand('copy'); $('#infoCopied').show();" type="text"/>						
						</div>
						<div><label>${messageEditIframe}</label>
						<input class="col-md-12 form-control" readonly="readonly" value="${window.location.origin}${editIframUrl}" onclick=" this.select();document.execCommand('copy'); $('#infoCopied').show();" type="text"/>						
						</div>
						`,
			draggable: true,
			dragWindowGap: 100,
			backgroundDismiss: true,
			closeIcon: true,
			buttons: {
				Copy: {
					text: "Copy",
					btnClass: 'btn btn-sm btn-circle btn-outline btn-primary',
					action: function(){ 
						copyURL(window.location.origin + url);
					}	
				},
				Ok: {
					text: "Ok",
					btnClass: 'btn btn-sm btn-circle btn-outline btn-primary',
					action: function(){ 
					}											
				}
			}
		});
	};
	
	function encodeQueryData(data) {
		   const ret = [];
		   for (let d in data)
		     ret.push(encodeURIComponent(d) + '=' + encodeURIComponent(data[d]));
		   return ret.join('&');
		}
	
	
	var showExportPDFDialog = function(id){
		
		var messageExportPDF = [[#{dashboards.export.pdf}]];
		var messageStandbyTime = [[#{dashboards.export.wait}]];
		var messageheight= [[#{dashboards.export.height}]];
		var messagewidth= [[#{dashboards.export.width}]];		
		var messagepresetsize= [[#{dashboards.export.presetsize}]];
		var messageparams= [[#{dashboards.export.params}]];
		var globalMessage=[[#{dashboards.export.emptyfields}]];
		
		$.confirm({
			icon: 'la la-file-pdf-o font-hg',
			title: messageExportPDF,
			theme: 'light',
			columnClass: 'medium',
			content:`	
				<div class="form-body container-fluid">	
				<div id="imagehaserror" class="alert alert-danger display-hide">
				<span >${globalMessage}</span>
			    </div>
					<div class="row">
						<div class="col-md-6 col-sm-6 col-xs-12">
						<div class="form-group">
							<label >${messageStandbyTime}</label><span class="required"> (*)</span>
							<div class="input-icon ">
								<input
									id="pdfwaittime" type="number" 
									required="true" maxlength="100"
									 class="form-control "  minlength="1" required value="20000" />
						     </div>
					    </div>
				        </div>	
				        
					 </div>
					 <div class="row">
					 <div class="col-md-4 col-sm-6 col-xs-12">
						<div class="form-group">
							<label >${messagepresetsize}</label>
							  <select id="pdfselectsize" class="form-control"  data-live-search="true" data-width="100%"  onchange="updateheightwidthpdf()">
							   <option   value="A0 H" >A0 H</option>
							   <option   value="A0 V" >A0 V</option> 
							   <option   value="A1 H" >A1 H</option>
							   <option   value="A1 V" >A1 V</option> 
							   <option   value="A2 H" >A2 H</option>
							   <option   value="A2 V" >A2 V</option>
							   <option   value="A3 H" >A3 H</option>
							   <option   value="A3 V" >A3 V</option>
							   <option selected  value="A4 H" >A4 H</option>
							   <option   value="A4 V" >A4 V</option>
							   <option   value="A5 H" >A5 H</option>
							   <option   value="A5 V" >A5 V</option>
							   <option   value="A6 H" >A6 H</option>
							   <option   value="A6 V" >A6 V</option>							   
						      </select>
					    </div>
				        </div>		
						<div class="col-md-4 col-sm-6 col-xs-12">
						<div class="form-group">
							<label >${messageheight}</label><span class="required"> (*)</span>
							<div class="input-icon ">
								<input
									id="pdfheight" type="number" 
									required="true" 
									 class="form-control "  minlength="1" required value="794" />
						     </div>
					    </div>
				        </div>	
				        <div class="col-md-4 col-sm-6 col-xs-12">
						<div class="form-group">
							<label >${messagewidth}</label><span class="required"> (*)</span>
							<div class="input-icon ">
								<input
									id="pdfwidth" type="number" 
									required="true" 
									 class="form-control "  minlength="1" required value="1123" />
						     </div>
					    </div>
				        </div>
				        
				        
				        
					 </div>
					 <div class="row">
						 <div class="col-md-12 col-sm-12 col-xs-12">
							<div class="form-group">
								<label>${messageparams}</label>														
								<textarea id="pdfparams"   class="form-control" rows="2" data-min-rows='2'></textarea>
							</div>							
						</div>
					</div> 
				</div>
						`,
			draggable: true,
			dragWindowGap: 100,
			backgroundDismiss: true,
			closeIcon: true,
			buttons: {				
				Ok: {
					text: "Ok",
					btnClass: 'btn btn-sm btn-circle btn-outline btn-primary',
					action: function(){ 						
						var token = $('#oauthToken').html().substring(7,$('#oauthToken').html().length);;						
						var pdfparams = $('#pdfparams').val();
						var pdfwidth = $('#pdfwidth').val();
						var pdfheight = $('#pdfheight').val();
						var checkboxfullscreen = $('#checkboxfullscreen').val();
						var pdfwaittime = $('#pdfwaittime').val();
						var ident = id;
						var csrf_value = $("meta[name='_csrf']").attr("content");
						var csrf_header = $("meta[name='_csrf_header']").attr("content"); 					
						var ok = true;	
						
						var data ={};
						if(typeof pdfparams ==='undefined' || pdfparams.trim().length===0){
							data = {
									waittime:pdfwaittime,
							    	height:pdfheight,
							    	width:pdfwidth,
							    	fullpage:checkboxfullscreen,
							    	token:token			    	
						    }
						}else{
							data = {
									waittime:pdfwaittime,
							    	height:pdfheight,
							    	width:pdfwidth,
							    	fullpage:checkboxfullscreen,
							    	token:token,
							    	params:pdfparams
							    }
						}
						var ok = typeof pdfwidth!=='undefined' && pdfwidth!==null  && pdfwidth.trim().length>0
							&& typeof pdfheight!=='undefined' && pdfheight!==null  && pdfheight.trim().length>0
							&& typeof pdfwaittime!=='undefined' && pdfwaittime!==null  && pdfwaittime.trim().length>0 ;	
						if(ok){
							var downloadUrl ='/controlpanel/dashboards/generatePDFImage/'+id+'?'+ encodeQueryData(data);							    
					    	var download = document.createElement('a');
					    	download.href = downloadUrl;					    	
					    	download.click();							    	
					    	return true;
						} else{
							$('#imagehaserror').show();
							return false;
						}
						}
					}											
				
			}
		});
	};
	
	
	function updateheightwidthimage(){
		var selected = $('#imageselectsize').val();
		var dimensions = getDimensions(selected);
		$('#imageheight').val(dimensions.height);
		$('#imagewidth').val(dimensions.width);
	}

	function updateheightwidthpdf(){
		var selected = $('#pdfselectsize').val();
		var dimensions = getDimensions(selected);
		$('#pdfheight').val(dimensions.height);
		$('#pdfwidth').val(dimensions.width);
	}
	
	
	function getDimensions(selected){
		//A4 H 96PPI/DPI
		var height=794;
		var width=1123;
		if(selected==="A0 V"){
			height=4494;
	    	width=3179;			
		}else if(selected==="A0 H"){
			 height=3179;
			 width=4494;			
		}else if(selected==="A1 V"){
			height=3179;
	    	width=2245 ;			
		}else if(selected==="A1 H"){
			 height=2245;
			 width=3179;			
		}else if(selected==="A2 V"){
			height=2245;
	    	width=1587;			
		}else if(selected==="A2 H"){
			 height=1587;
			 width=2245;			
		}else if(selected==="A3 V"){
			height=1587;
	    	width=1123;			
		}else if(selected==="A3 H"){
			 height=1123;
			 width=1587;			
		}else if(selected==="A4 V"){
			height=1123;
		    width=794;			
		}else if(selected==="A4 H"){
			 height=794;
			 width=1123;			
		}else if(selected==="A5 V"){
			height=794;
	    	width=559;			
		}else if(selected==="A5 H"){
			 height=559 ;
			 width=794;			
		}else if(selected==="A6 V"){
			height=559;
	    	width=397;			
		}else if(selected==="A6 H"){
			 height=397 ;
			 width=559;			
		}		
		return {'height':height,'width':width};
	}
	
	function navigateUrl(url){  window.location.href = url;	}
	function navigateNewTab(url){ window.open(url, '_blank');  	}
	
	var  deleteDashboardConfirmation = function (id){
	
		showConfirmDeleteDialog(id);	
	} 
	
	var deleteUrl =  [[@{/dashboards}]];
	var showConfirmDeleteDialog = function(id){	
		$('#delete_dashboard_form').attr('action', deleteUrl + '/' + id);
		$('#delete-id').val(id);
		HeaderController.showConfirmDialogDashboard('delete_dashboard_form');	
	}
	
	var copyURL = function(url){
			var $temp = $("<input />");
			$("body").append($temp);
			$temp.val(url).select();
			document.execCommand("copy");
			$temp.remove();
			
	}		

	// MAIN WHEN READY
	$( document ).ready(function() {
	
	
		
		//SHOW/HIDE DATATABLE COLUMNS HANDLER
		$('label.toggle-vis').on( 'click', function (e) {
			e.preventDefault(); 
			// Get the column API object
			var column = $('#dashboards').DataTable().column( $(this).attr('data-column') ); 
			// Toggle the visibility
			column.visible( ! column.visible() );			
			// toggle Text
			$(this).toggleClass('text-muted line-through');			
		});	
		
		// SEARCH FORM RESET
		$('#reset_dashboard').on('click',function(){
			$('#form_dashboard')[0].reset();
			$('#form_dashboard')[0].submit();
		});
		
		var createDashboard = function(name){
			$.post(
				"/controlpanel/dashboards/create", 
				{identification : name}
			).done(function(id){
				navigateUrl("/controlpanel/dashboards/editfull/" + id)}
			).fail(
				function(e){
					console.log("Error creating dashboard, message detail: " + e.responseText);
				}
			)
		}
		
		var createDashboardDialog = function(){
			$.confirm({
				icon: 'fas fa-chart-pie',
				title: "Insert the new dashboard name",
				theme: 'light',
				columnClass: 'medium',
				content: "<input class='col-md-12 form-control' type=text id='newDashboard'></input>",
				draggable: true,
				dragWindowGap: 100,
				backgroundDismiss: true,
				closeIcon: true,
				buttons: {
					close: {
						text: Close,
						btnClass: 'btn btn-sm btn-circle btn-outline blue',
						action: function (){} //GENERIC CLOSE.		
					},
					Ok: {
						text: "Ok",
						btnClass: 'btn btn-sm btn-circle btn-outline btn-blue',
						action: function(){ 
							if($("#newDashboard").val()=="" || !$("#newDashboard").val()){
				                console.log("dashboard empty");
				                return;
				            }
				            createDashboard($("#newDashboard").val());
				            $( this ).dialog( "close" );
						}											
					}					
				}
			});
		}		
		
		
		/*$("#createDashboardButton").on("click", createDashboardDialog);*/
		// SEARCH FORM
		$('#search_dashboard').on('click',function(){ $('#form_dashboard')[0].submit(); });
		
		
		
	});
	 
	// MAIN WHEN LOAD
	$(window).load(function(){  
		
		// HIDE COLUMNS (DeESCRIPTION,  CREATEDAT)		
		$.each([1,3,7],function(ind,value){ $("label.toggle-vis[data-column='"+ value +"']").trigger('click'); });
		
		// SHOW/HIDE DATATABLES COLUMN INIT 		
		$('.dataTables_filter').append($('#dataTable-vis-toggle'));		
		$('#dataTable-vis-toggle').removeClass('hide');
		
	});	
	
	
	
	var showImportDashboardDialog = function(){
		var textCreated =  [[#{dashboards.ontologies.must.be.created}]];
		var textOverwrite = [[#{dashboards.overwrite}]];
		var textimportAuth = [[#{dashboards.importAuthorizations}]];
		$.confirm({
			icon: 'fas fa-chart-pie',
			title: [[#{dashboards.importdashboard}]],
			theme: 'light',
			columnClass: 'medium',
			content: "<div class='alert alert-info' role='alert'><i class='fa fa-info-circle'></i><span >&nbsp" + textCreated + " </span> </div><input class='element text form-control' type='text' id='newImportDashboard' placeholder=''/><br/><label id='patternAlert' class='hidden col-md-12 alert alert-warning'>Pattern [a-zA-Z0-9_ ]+</label><br/><input type='hidden' id='dataJSONImport' /><input class='element text form-control' type='file' accept='.json' id='jsonInputData' onchange='fileImportChange(this.files[0])' /><div class='form-group'><div class='mt-checkbox-list'> <label class='mt-checkbox font-md popovers' data-trigger='hover' data-placement='top' data-container='body' ><i class='la la-lightbulb-o'></i> <div class='inline font-xs' >"+textOverwrite+"</div>        <input id='overwritecheck' name='overwritecheck' type='checkbox' class='no-remove' checked='checked'/>        <span></span><!-- needed by styles -->    </label>     <label class='mt-checkbox font-md popovers' data-trigger='hover' data-placement='top' data-container='body' ><i class='la la-lightbulb-o'></i> <div class='inline font-xs'>"+textimportAuth+"</div>        <input id='importAuthcheck' name='importAuthcheck' type='checkbox' class='no-remove'  checked='checked'/>        <span></span><!-- needed by styles -->    </label></div></div>",
			draggable: true,
			dragWindowGap: 100,
			backgroundDismiss: true,
			closeIcon: true,
			buttons: {
				close: {
					text: "Cancel",
					btnClass: 'btn btn-sm btn-outline btn-circle blue',
					action: function (){} //GENERIC CLOSE.		
				},
				Ok: {
					text: "Ok",
					btnClass: 'btn btn-sm btn-outline btn-circle btn-primary',
					action: function() {
						
						if($("#newImportDashboard").val()=="" || !$("#jsonInputData").val() || $("#jsonInputData").val()=="" || !$("#newImportDashboard").val()){
							console.log("dashboard name or json file empty");
							return;
						}
						var dashboardName = $("#newImportDashboard").val().trim();
						var dashboardExtension = $("#jsonInputData").val().split('.').pop();
						if(/^[a-zA-Z0-9_ ]+$/.test(dashboardName)){
							importDashboard(dashboardName,$("#dataJSONImport").val(), dashboardExtension,$("#overwritecheck").is(":checked"),$("#importAuthcheck").is(":checked"));
						}
						else{
							$("#patternAlert").removeClass("hidden");
							return false;
						}
					}									
				}
			}
		});
	}

	var showImportDashboardTableDialog = function(identifier){
		
		var textCreated =  [[#{dashboards.ontologies.must.be.created}]];
		var textOverwrite = [[#{dashboards.overwrite}]];
		var textimportAuth = [[#{dashboards.importAuthorizations}]];
		$.confirm({
			icon: 'fas fa-chart-pie',
			title: [[#{dashboards.importdashboard}]],
			theme: 'light',
			columnClass: 'medium',
			content: "<div class='alert alert-info' role='alert'><i class='fa fa-info-circle'></i><span >&nbsp" + textCreated + " </span> </div><input type='hidden' id='dataJSONImport' /><input class='element text form-control' type='file' accept='.json' id='jsonInputData' onchange='fileImportChange(this.files[0])' /><div class='form-group'><div class='mt-checkbox-list'> <label class='mt-checkbox font-md popovers' data-trigger='hover' data-placement='top' data-container='body' ><i class='la la-lightbulb-o'></i> <div class='inline font-xs' >"+textOverwrite+"</div>        <input id='overwritecheck' name='overwritecheck' type='checkbox' class='no-remove' checked='checked'/>        <span></span><!-- needed by styles -->    </label>     <label class='mt-checkbox font-md popovers' data-trigger='hover' data-placement='top' data-container='body' ><i class='la la-lightbulb-o'></i> <div class='inline font-xs'>"+textimportAuth+"</div>        <input id='importAuthcheck' name='importAuthcheck' type='checkbox' class='no-remove'  checked='checked'/>        <span></span><!-- needed by styles -->    </label></div></div>",
			draggable: true,
			dragWindowGap: 100,
			backgroundDismiss: true,
			closeIcon: true,
			buttons: {
				close: {
					text: "Cancel",
					btnClass: 'btn btn-sm btn-outline btn-circle blue',
					action: function (){} //GENERIC CLOSE.		
				},
				Ok: {
					text: "Ok",
					btnClass: 'btn btn-sm btn-outline btn-circle btn-primary',
					action: function() {
						if(identifier =="" || !$("#jsonInputData").val() || $("#jsonInputData").val()=="" || ! identifier){
							console.log("json file empty");
							return;
						}
						
						var dashboardExtension = $("#jsonInputData").val().split('.').pop();
						importDashboard(identifier,$("#dataJSONImport").val(), dashboardExtension,$("#overwritecheck").is(":checked"),$("#importAuthcheck").is(":checked"));						
						
					}									
				}
			}
		});
	}
	
	function navigateUrl(url,reload){ 
		if(reload){
			window.location.reload();
			window.location.replace(url);
		}
		else{
			window.location.href = url;
		}
	}

	function importDashboard(name,data,extension,overwrite,importAuthcheck){
		if($("#jsonInputData").val()==="" || $("#newImportDashboard").val()===""){
			return;//Required params
		}
		
		console.log(name);
		console.log(extension);
		
		var url = "/controlpanel/dashboards/importDashboard?overwrite="+overwrite+"&importAuthorizations="+importAuthcheck;
			//Name inside notebook
			try {
				var jsonData = JSON.parse(data)
				jsonData.identification = name;
				data = JSON.stringify(jsonData);
			}catch(error) {
				$.alert({title: 'ERROR!', theme: 'light',  content: /*[[#{dashboards.error.invalidformat}]]*/ 'Error' 
					}
				)
				}
			$.ajax({
			    contentType: 'application/json',
			    data: data,
			    dataType: 'json',
			    success: function(data){			    	
			    	navigateUrl("/controlpanel/dashboards/list/",true);
			    },
			    error: function(e){			    	
			    	if(e.statusCode().status==409){
						$.alert({title: 'ERROR!', theme: 'light',  content: /*[[#{dashboards.error.duplicate}]]*/ 'Error'
							}
						)
						console.log("Error importing dashboard, message detail, " + " error: " + e.error + ", " + e.responseText);
					}
					else if (e.statusCode().status==400){
						$.alert({title: 'ERROR!', theme: 'light',  content: /*[[#{dashboards.error.invalidformat}]]*/ 'Error'
							}
						)
						console.log("Error importing dashboard, message detail, " + " error: " + e.error + ", " + e.responseText);
					}
			    },
			    processData: false,
			    type: 'POST',
			    url: url
			});
			
   }
	
	function fileImportChange(jsonFile){
		var reader = new FileReader();
		reader.readAsText(jsonFile);
		var nameDashboard;
		reader.onload = function(data) {		
			nameDashboard = JSON.parse(data.target.result).name;
			$('#newImportDashboard').val(nameDashboard);
			$('#dataJSONImport').val(data.target.result);
			
		};
	}
	
	
	//]]>
	</script>
	
</body>
</html> 
