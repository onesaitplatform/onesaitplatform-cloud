<!--

    Copyright Indra Soluciones Tecnologías de la Información, S.L.U.
    2013-2022 SPAIN

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
         http://www.apache.org/licenses/LICENSE-2.0
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<!-- Copyright Indra Sistemas, S.A. 2013-2018 SPAIN -->
<html xmlns:th="http://www.thymeleaf.org" th:with="lang=${#locale.language}" th:lang="${lang}">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
        <meta http-equiv="Content-Language" th:content="${lang}" />
        <title th:text="#{name.app}" />
        
        <!-- STYLE SHEETS -->
        <link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/bootstrap.min.css}" />
        <link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/components.css}" />
        <link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/plugins.css}" />
        <link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/layout.css}" />
        <!-- THEME -->
        <link rel="stylesheet" type="text/css" media="all" th:href="@{/static/webjars/sofia2_theme/css/sofia2.css}" />
      
        
        <!-- PLUGINS STYLE SHEETS: BOOSTRAP-SELECT , BOOSTRAP-TIMEPICKER AND CODEMIRROR  -->
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/bootstrap-select/bootstrap-select.min.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/bootstrap-datepicker/bootstrap-datepicker3.min.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/bootstrap-tagsinput/bootstrap-tagsinput.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/lib/codemirror.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/neat.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/ambiance.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/material.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/neo.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/elegant.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/json/jsoneditor.css}"/>
    
    </head>

    <!-- page-sidebar-closed to START WITH MENU COLLAPSED. -->
    <body class="page-header-fixed  page-content-white page-sidebar-closed">
    
    	<!-- MAIN PAGE WRAPPER -->
    	<div class="page-wrapper">
    
    		<!-- BEGIN HEADER INCLUDE -->
    		<div th:include="fragments/header::#headerFragment"	class="page-header navbar navbar-fixed-top"></div>
    		<!-- END HEADER -->
    
    		<!-- HEADER AND CONTENT DIVIDER -->
    		<div class="clearfix"></div>
    
    		<!-- BEGIN SIDEBAR INCLUDE (MENU) -->
    		<div th:include="fragments/menu::#menuFragment"	class="page-sidebar-wrapper"></div>
    		<!-- END SIDEBAR -->
    
    		<!-- BEGIN CONTENT -->
    		<div class="page-content-wrapper">
    
    			<!-- BEGIN CONTENT BODY -->
    			<div class="page-content">
    				<!-- BEGIN PAGE BAR AND BREADCRUM-->
    				<div class="page-bar margin-bottom-20">
    					<ul class="page-breadcrumb">
    						<li><a th:href="@{/predictors/list}"> <span th:text="#{predictor.my}">My Predictors</span></a><i class="fa fa-angle-right"></i></li>
    						<li>
    							<span th:text="#{predictor.create}">Create Predictor</span>
    						</li>
    					</ul>
    				</div>	
    				<!-- END PAGE BAR -->
    
    				<!-- BEGIN PAGE TITLE-->
    				<h1 class="page-title hide ">
    					<span th:text="#{name.app}"> onesait platform Control Panel</span>
    				</h1>
    				<!-- END PAGE TITLE-->
    
                    <form role="form" id="form-predictor" th:object="${predictor}" method="post" class="form" th:action="@{/predictors/create}">
						<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
						<input type="hidden" th:field="*{targetFields}" id="targetFields"/>
						<input type="hidden" th:field="*{inputFields}" id="inputFields"/>
						<input type="hidden" th:field="*{ontology}" id="ontology"/>
						
                        <div id="header">
                            <div class="row pageCreateHeader">
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    <div class="margin-top-4">
                                        <span  class="caption-subject" th:text="#{predictor.create}"> Create Predictor</span>
                                    </div>
                                </div>
                                <div class="tools hide">
                                    <a href="" class="collapse" data-original-title="" title="">
                                    </a> <a href="" class="fullscreen" data-original-title="" title="">
                                    </a>
                                </div>
                                <div class="actions hide">
                                    <!-- ACTION INDICATORs -->
                                    <span class="label label-success label-sm uppercase"><i class="fa fa-plus"></i> <span th:text="#{gen.mode.insert}">Insert</span></span>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                <div class="pull-right">
	                                   <!-- CANCEL  -->
	                                   <button th:attr="onclick='javascript:navigateUrl(\''+@{|/predictors/list|}+'\');'" id="btn-cancel" name="btn-cancel" type="button" class="btn btn-circle btn-outline blue no-border" th:value="#{gen.cancelBtn}" value="cancel"><span th:text="#{gen.cancelBtn}"> Cancel </span>
	                                   </button>
	
	                                   <!-- CREATE / UPDATE-->
	                                   <button id="btn-download" type="submit" class="btn btn-circle btn-outline btn-primary">
	                                       <span th:text="#{gen.createBtn}"> New </span>
	                                   </button>
	                               </div>
	                           </div>
                            </div>
                        </div>
                        <!-- ROWS -->
                       	<div class="row main query-configuration" style="box-shadow: inset 0px -1px 0px #d7dadc;" >
	                       	<div class="col-md-12 col-sm-12 col-xs-12 ">
	                       		<div class="col-md-3 col-sm-6 col-xs-12">
                                    <div class="form-group">
                                        <label th:text="#{predictor.name}"></label><span class="required"> *</span>
                                        <input id="identification" type="text" name="identification" th:required="true" maxlength="100" th:field="*{name}" class="form-control " th:placeholder="#{gen.name}"/>
                                        <span id="identificationerror" class="help-block" style="margin-left: 5px;" th:text="#{ontology.description.min}"><i class="la la-warning"></i></span>
                                    </div>
                                </div>
		                        <div class="col-md-3 col-sm-3 col-xs-12" >							
									<div class="form-group">								
										<label class="description" th:text="#{database.ontology}" > ONTOLOGIES </label><span class="required"> *</span>												
										<select class="selectpicker  select show-tick form-control" id="ontologies-select" data-live-search="true"  th:required="true" data-icon-Base="fa" data-tick-Icon="fa-check" data-size="15" data-width="100%" th:title="#{database.ontologies} +'...'">
										  <optgroup th:label="#{database.generic}">
											<option th:each="ontology : ${ontologies}" th:id="${ontology.user.userId}" th:data-description="${ontology.description}" data-type="general" th:value="${ontology.identification}" th:text="${ontology.identification}"  ></option>
										  </optgroup>											
										</select>
									</div>
								</div>
								
							</div>
						</div>
						<div class="panel-query-with-header hide" id="field-wizard">
							<div class="panel-body query-wizard-div no-space ">	
								<div class="panelHeader col-md-12 col-sm-12 col-xs-12">
									<span  th:text="#{predictor.selectfields}"> Query wizard </span>
								</div>
								<div class="panel-tools">	
																	
								<div class="clearfix"></div>
								</div>								

								<!-- BEGIN QUERY ASSEMBLER -->
								<div id="crear-query">
									<div class="col-md-12 no-space">
									  <div id="create_query">
											<ul id="tree_menu" style="padding: 16px 0px 12px 12px">
											  
												<!-- SELECT PANEL -->
												
												<div class="form-group col-xs-6" id="select-input" style=" padding-left: 5px;">
												<label class="idescription" th:text="#{predictor.inputfields}" > Input </label>
												<select  class="selectpicker  select show-tick form-control" data-actions-box="true" th:attr="data-deselect-all-text=#{querytool.deselect.all},data-select-all-text=#{querytool.select.all}" multiple="multiple"  data-live-search="true" data-icon-Base="fa" data-tick-Icon="fa-check"  data-width="100%"    name="inputfields" >
													
												</select>
												</div>
												<div class="form-group col-xs-6" id="select-target" style=" padding-left: 5px;">
												<label class="idescription" th:text="#{predictor.targetfields}" > Target </label>
												<select  class="selectpicker  select show-tick form-control" data-actions-box="true" th:attr="data-deselect-all-text=#{querytool.deselect.all},data-select-all-text=#{querytool.select.all}" multiple="multiple"  data-live-search="true" data-icon-Base="fa" data-tick-Icon="fa-check"  data-width="100%"    name="targetfields" >
												</select>
												</div>
											</ul>
										</div>
									</div>
										
									<div class="col-sm-12 col-md-12" style="display:none"> 
									  <!-- BEGIN TABLE -->
									  <table id="camposConsultaSuscripcion" >
										
										  <tbody th:remove="all-but-first" >
											<tr pages:paginate="10" class="odd">
											  <td>
												  <div id="checks" ></div>    
											  </td>
										   </tr>
										 </tbody>
									  </table>
									  <!-- END TABLE -->
									</div>
								</div>								
							<!-- END QUERY ASSEMBLER -->										
							</div>	
						</div>
						<div id="query-divs" class="hide">
						<div class="col-md-2 col-sm-2 col-xs-2">
                  			<div class="form-group">
	                 			<label class="description" th:text="#{apimanager.customsql.querytype}"></label>
			                    <select  id="id_customsql_querytype" class=" selectpicker form-control" >
			                         <option value="sql" th:text="SQL" selected="selected"/>
			                         <option value="native" th:text="NATIVE"/>
			                    </select>
		                    </div>
                     	</div>
                     	<div class="col-md-2 col-sm-2 col-xs-2">
                     		<div class="form-group">
                     			<button disabled="disabled" type="button" class="btn btn-circle btn-outline blue" style="margin-top: 25px"  onclick="getQueryExecutedFragment()" id="executeQuery" > <span th:text="#{database.execQuery}">Execute Query</span> </button>
                     		</div>
	                    </div>
						<div class="col-md-12 col-sm-12 col-xs-12">
			                <label class="description panelHeader" th:text="#{apimanager.customsql.query}" th:title="#{apimanager.customsql.query.info}"></label>
			                <div style="height:200px; resize: vertical; overflow: auto;" id="id_query_op_customsql"></div>
						</div>
						<div id="result-panel" class="col-md-12">
							<!-- RESPUESTA DE CONSULTA -->
							<div class="hide" id="Canvasrespuesta">
								<div id="theQueryResponse" th:fragment="query" th:text="${queryResult}"></div>
							</div>
							<div id="jsoneditor" data-loaded="false" style="height: 300px;"></div>
	                   </div>
	                   </div>
                    </form>
    			</div><!-- END CONTENT BODY -->
    		</div><!-- END CONTENT page-content-wrapper -->
    	</div><!-- END MAIN PAGE WRAPPER -->
    
    	<!-- FOOTER INCLUDE -->
    	<footer th:include="fragments/footer::#footerFragment" class="page-footer"> </footer>
    	<div class="hide" th:fragment="fields" id="fields">
			<script th:inline="javascript">
			//Map with field,type struct	
			campos= [[${fields}]];
			</script>
				<!-- <option th:id="selectFields" th:text="#{querytool.select.fields}"></option>
				<option th:id="all" th:text="#{querytool.all.fields}"></option> -->
				<option th:each="field :${fields}" th:value="${field.key}" th:id="check + ${field.key}" th:text="${field.key}" th:type="${field.value}"/>
			
		</div>
    		
   
    	
    		
    	<!-- PLUGINS -->
		<script th:src="@{/static/vendor/bootstrap-select/bootstrap-select.min.js}"></script>
		<script th:src="@{/static/vendor/bootstrap-datepicker/bootstrap-datepicker.min.js}"></script>
		<script th:src="@{/static/vendor/codemirror/lib/codemirror.js}"></script>
		<script th:src="@{/static/vendor/codemirror/mode/javascript/javascript.js}" ></script>
		<script th:src="@{/static/vendor/codemirror/addon/edit/matchbrackets.js}" ></script>
		<script th:src="@{/static/vendor/codemirror/addon/edit/closebrackets.js}" ></script>
		<script th:src="@{/static/vendor/codemirror/addon/selection/active-line.js}" ></script>
		<script th:src="@{/static/vendor/codemirror/addon/comment/comment.js}" ></script>
		<script th:src="@{/static/vendor/codemirror/addon/comment/continuecomment.js}" ></script>
    	
    	<!-- LOADING DEFAULT DATES IF NEEDED -->
    	<script th:if="${lang} == 'es'" th:src="@{/static/vendor/bootstrap-datepicker/locales/bootstrap-datepicker.es.min.js}" type="text/javascript"></script>
    	<script	th:src="@{/static/vendor/jquery-validation/jquery.validate.min.js}" type="text/javascript"></script>
    	<script	th:src="@{/static/vendor/jquery-validation/additional-methods.min.js}" type="text/javascript"></script>
    
    	<!-- LOADING DEFAULT LANG MESSAGES IF NEEDED -->
    	<script th:if="${lang} == 'es'" th:src="@{/static/vendor/jquery-validation/localization/messages_es.min.js}" type="text/javascript"></script>
    	<script th:src="@{/static/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js}" type="text/javascript"></script>
    	<script th:src="@{/static/vendor/json/mountable.min.js}" type="text/javascript"></script>
    	
  
    	
    	<!-- INPUTMASK -->
    	<script th:src="@{/static/vendor/jquery-inputmask/dist/min/jquery.inputmask.bundle.min.js}"></script>
    	
    	<!-- CORE JS CONTROLLERS -->
    	<script th:src="@{/static/js/app.js}"></script>
    	<script th:src="@{/static/js/layout.js}"></script>	
    	
    		<!-- BEAUTIFIER -->
		<script src="/controlpanel/static/vendor/beautify/beautify.js"></script>
		<script src="/controlpanel/static/vendor/beautify/beautify-css.js"></script>
		<script src="/controlpanel/static/vendor/beautify/beautify-html.js"></script>
	
		<!-- JSON EDITOR & ACE -->
		<script th:src="@{/static/vendor/json/jsoneditor.js}"></script>
		<script th:src="@{/static/vendor/ace/ace.js}" charset="utf-8"></script>
		<script th:src="@{/static/vendor/ace/mode-json.js}"></script>
		<script th:src="@{/static/vendor/ace/theme-textmate.js}"></script>
		<script th:src="@{/static/vendor/ace/ace-noconflict.js}" charset="utf-8"></script>
	
		<!-- MONACO EDITOR -->
		<script>
		    var require = { paths: { 'vs': '/controlpanel/static/vendor/vs' } };
		</script>
		<script th:src="@{/static/vendor/vs/loader.js}"></script>
		<script th:src="@{/static/vendor/vs/editor/editor.main.nls.js}"></script>
		<script th:src="@{/static/vendor/vs/editor/editor.main.js}"></script>
	    	
    	<script th:inline="javascript">
    	//<![CDATA[
    		
    		var currentLanguage = [[${lang}]];
    		var labelSelectAll		= [[#{querytool.select.all}]];
    		var labelDeselectAll	= [[#{querytool.deselect.all}]];
    		var csrfParameter = [[${_csrf.parameterName}]];
    		var csrfValue = [[${_csrf.token}]];
    		function navigateUrl(url){  window.location.href = url;	}
    		var fieldsURL = [[@{/querytool/ontologyfields}]];
    		var inputfieldsLabel = [[#{predictor.inputfields}]]
    		var targetfieldsLabel = [[#{predictor.targetfields}]]
    		var validationPrediction = [[#{predictor.validation.select}]]
    		var validateIdentifiation =  [[#{ontology.index.nameError}]]
    		
    		$(window).on("load",function(){
    			var htmlelement = document.getElementById('id_query_op_customsql');
    			var readonly = false;
    			
    			codeEditor = monaco.editor.create(htmlelement, {
    			       language: 'sql',
    			       scrollBeyondLastLine: false,
    			       readOnly: readonly,
    			       theme: "vs-dark",
    			       automaticLayout: true
    			});
    		})
    		
    		$( document ).ready(function() {
				$('#identification').bind('blur', function (ev) { // fires on every blur
			validateName();             // checks form for validity
		})
    			$('#ontologies-select').off().on('change', function(){
    				let ontology = $('#ontologies-select').val();
    				$('#field-wizard').removeClass('hide');
    				$('#query-divs').removeClass('hide');
    				$('#executeQuery').prop("disabled", false);
    				$('#id_customsql_querytype').prop("disabled", false);
    				codeEditor.setValue(`SELECT * FROM ${ontology} limit 3`)
    				//Load fields 
    				getOntologyFields(true);
    			})
    			$('#form-predictor').off().on('submit', function(e){
    				e.preventDefault();
    				validateAndSubmit();
    			})
    			
    		})
    		
    		function loadComboSelect(){
				var comboFields=$('#fields').html();
				$('#select-input').empty();
				$('#select-input').append(`<label class="idescription" >${inputfieldsLabel} </label><select id="checkselect-input" data-actions-box="true" data-deselect-all-text="${labelDeselectAll}"  data-select-all-text="${labelSelectAll}" multiple="multiple" data-icon-base="fa" data-tick-icon="fa-check"  data-live-search="true" class="select show-tick form-control" data-width="100%">${comboFields}</select></div>`);
				$('#checkselect-input').selectpicker('refresh');
				$('#select-target').empty();
				$('#select-target').append(`<label class="idescription" >${targetfieldsLabel} </label><select id="checkselect-target" data-actions-box="true" data-deselect-all-text="${labelDeselectAll}"  data-select-all-text="${labelSelectAll}" multiple="multiple" data-icon-base="fa" data-tick-icon="fa-check"  data-live-search="true" class="select show-tick form-control" data-width="100%">${comboFields}</select></div>`);
				$('#checkselect-target').selectpicker('refresh');
			}
    		function getOntologyFields(loadCombo) {
    			if($("#ontologies-select").val()!=""){
    				var csrf_value = $("meta[name='_csrf']").attr("content");
    				var csrf_header = $("meta[name='_csrf_header']").attr("content");
    				
    				$.ajaxSetup({'headers': {
    					[csrf_header]: csrf_value
    			    }});
    				if(typeof loadCombo != 'undefined' && loadCombo == true){
    					$("#fields").load('/controlpanel/querytool/ontologyfields', { 'ontologyIdentification': $("#ontologies-select").val()},function(response, status, xhr){ loadComboSelect();})
    				}else{
    					$("#fields").load('/controlpanel/querytool/ontologyfields', { 'ontologyIdentification': $("#ontologies-select").val()})
    				}
    			}
    		}
	    	var validateName = function(){		
				var identification = $('#identification').val();
				var error1 = $('.alert-danger');
				if(typeof identification === 'undefined' || identification.trim().length < 5 || identification == '' ){
					error1.show();
					$('#identificationerror').removeClass('hide').addClass(' font-red');
					$('#identification').closest('.form-group').addClass('has-error')
					return false;
				}else{
					$('#identificationerror').addClass('hide');
					$('#identification').closest('.form-group').removeClass('has-error')
					return true;
				}
			}
    		
    		function validateAndSubmit(){
				validateName();
    			let inputFields = $('#checkselect-input').val();
    			let targetFields = $('#checkselect-target').val();
    			let ontology = $("#ontologies-select").val();
    			let identification = $("#identification").val();
    			if(ontology === null || targetFields === null){
    				toastr.info(messagesForms.operations.genOpError,`${validationPrediction}`);
    			}else if(identification == "" || identification.length < 5){
					toastr.error(messagesForms.operations.genOpError,`${validateIdentifiation}`);	
    			}else{
    				$('#ontology').val(ontology);
    				if(inputFields === null){
    					$('#inputFields').val("*");
    				}else{
    					$('#inputFields').val(inputFields);
    				}
    				$('#targetFields').val(targetFields);
    				$('#form-predictor').off();
    				$('#form-predictor').submit();
    			}
    			
    		}
    		
    		function getQueryExecutedFragment() {


    			timeStart = Date.now();
    			$('#pulse').attr('class', 'col-md-12');
    			$('#result-panel').attr('class', 'col-md-12 hide');
    			var payload ={ 'query': codeEditor.getValue(), 'queryType': $("#id_customsql_querytype").val(), 'ontologyIdentification': $("#ontologies-select").val()};
    			payload[headerJson.csrfParameterName] = headerJson.csrfToken;
    			$('#executeQuery').attr('disabled', true);
					$("#Canvasrespuesta").load('/controlpanel/querytool/query', payload,function(response){
						callbackQuery(response);
					});
    		}
    		var queryResponse;
    		function callbackQuery(response){

    			$('#executeQuery').attr('disabled', false);
    			$('#pulse').attr('class', 'col-md-12 hide');
    			var time = Date.now() - timeStart;
    			$('#query-ontologia-result').text('' + $('#selector_ontologias').val());
    			$('#timeResult').text('(Querytime: ' + time + ' ms)');
    			if ($('#result-panel').hasClass('hide')){ $('#result-panel').toggleClass('hide'); }
    			queryResponse = $(response);
    			// check for valid json, or server string error like java.lang.Exception...
    			var IS_JSON = true;
    			try{ var json = $.parseJSON(queryResponse.text());	} catch(err){ IS_JSON = false; }

    			if (!IS_JSON){
    				var text=""+queryResponse.text();
    				// Our own JSON string to mark non JSON ERRORs
    				queryErrorResponse = text;
    			}

    			if ($('#jsoneditor').attr('data-loaded') == 'false') { createEditor(); $('#jsoneditor').attr('data-loaded', true);	}
    			if (IS_JSON) {
    				dataJSON = queryResponse.text();
    				editor.setText(queryResponse.text());
    				editor.setMode('view');
    				if ($('.table-viewer').is(':visible')){ $('.btn-table-toggle').trigger('click'); } }else { editor.setMode('text');  editor.setText(queryErrorResponse); }

    		}
    		var createEditor = function(){


    			var container = document.getElementById('jsoneditor');
    			var options = {
    				mode: 'text',
    				theme: 'bootstrap3',
    				required_by_default: true,
    				modes: ['text', 'tree', 'view'], // allowed modes
    				error: function (err) {
    					$.alert({title: 'ERROR!', theme: 'light', style: 'red', content: err.toString()});
    					return false;
    				},
    				onChange: function(){


    				}
    			};

    			editor = new jsoneditor.JSONEditor(container, options, "");

    		}
    		
    	//]]>
    	</script>
    	
    </body>
</html>