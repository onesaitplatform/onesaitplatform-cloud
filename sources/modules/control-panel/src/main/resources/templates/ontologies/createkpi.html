<!--

    Copyright Indra Soluciones Tecnologías de la Información, S.L.U.
    2013-2021 SPAIN

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
         http://www.apache.org/licenses/LICENSE-2.0
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<html xmlns:th="http://www.thymeleaf.org"  th:with="lang=${#locale.language}" th:lang="${lang}">
	<head>
		<meta name="_csrf" th:content="${_csrf.token}"/>
		<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

		<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
		<meta http-equiv="Content-Language" th:content="${lang}"/>
		<title th:text="#{name.app}"/>


		<!-- STYLE SHEETS -->
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/bootstrap.min.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/components.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/plugins.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/css/layout.css}"/>
		<!-- THEME -->
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/webjars/sofia2_theme/css/sofia2.css}"/>

		<!-- PLUGINS STYLE SHEETS: BOOSTRAP-SELECT AND BOOSTRAP-TIMEPICKER, TAGSINPUT, JSONEDITOR, CODEMIRROR  -->
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/bootstrap-select/bootstrap-select.min.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/datatable/datatables.bootstrap.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/bootstrap-datepicker/bootstrap-datepicker3.min.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/bootstrap-tagsinput/bootstrap-tagsinput.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/json/jsoneditor.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/lib/codemirror.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/neat.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/ambiance.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/material.css}"/>
		<link rel="stylesheet" type="text/css" media="all" th:href="@{/static/vendor/codemirror/theme/neo.css}"/>


<style type="text/css">

.table-scrollable {
    width: 100%;
    overflow-x: auto;
    overflow-y: auto;
    border: 1px solid #e7ecf1;
    margin: 10px 0 !important;
    height: 300px;
}

</style>
	</head>

	<!-- page-sidebar-closed to START WITH MENU COLLAPSED. -->
	<body class="page-header-fixed  page-content-white page-sidebar-closed">

	<!-- MAIN PAGE WRAPPER -->
	<div class="page-wrapper">



		<!-- BEGIN HEADER INCLUDE -->
		<div th:include="fragments/header::#headerFragment" class="page-header navbar navbar-fixed-top"></div>
		<!-- END HEADER -->

		<!-- HEADER AND CONTENT DIVIDER -->
		<div class="clearfix"> </div>

		<!-- BEGIN SIDEBAR INCLUDE (MENU) -->
		<div th:include="fragments/menu::#menuFragment" class="page-sidebar-wrapper"></div>
		<!-- END SIDEBAR -->
		<!-- BEGIN CRON MODAL -->
		<div th:include="fragments/cron::#cronFragment"></div>
		<!-- END CRON MODAL -->
		<!-- BEGIN CONTENT -->
		<div class="page-content-wrapper">

			<!-- BEGIN CONTENT BODY -->
			<div class="page-content">

				<!-- BEGIN PAGE BAR AND BREADCRUM-->
				<div class="page-bar margin-bottom-20">
					<ul class="page-breadcrumb">
						<li><a th:href="@{/ontologies/list}">
							<span th:if="${#strings.arrayJoin(#authentication.authorities,'')} == 'ROLE_ADMINISTRATOR'"  th:text="#{ontology.template.list}">Manage Ontologies</span>
							<span th:if="${#strings.arrayJoin(#authentication.authorities,'')} != 'ROLE_ADMINISTRATOR'"  th:text="#{ontology.breadcrumb.list}">My Ontologies</span>
							</a><i class="fa fa-angle-right"></i>
						</li>
						<li th:if="${ontology?.id} == null"><a th:href="@{/ontologies/create}">
							<span th:text="#{ontology.breadcrumb.create}">Show Ontology</span></a><i class="fa fa-angle-right"></i>
						</li>
						<li>
							<span th:if="${ontology?.id} == null" th:text="#{ontology.breadcrumb.kpi.create}">New KPI</span>
							<span th:if="${ontology?.id} != null" th:text="#{ontology.breadcrumb.kpi.update}">Update KPI</span>
						</li>
					</ul>
				</div>
				<!-- END PAGE BAR -->

				<!-- BEGIN PAGE TITLE-->
				<h1 class="page-title hide "><span th:text="#{name.app}"> Onesait Platform Control Panel</span></h1>
				<!-- END PAGE TITLE-->

				<form id="delete_ontology_form" class="delete-ontology hide"  th:action="@{'/ontologies/'+${ontology.id}}"  method="post">
					<input type="hidden" name="_method" value="DELETE"/>
					<input id="delete-ontologyId" type="hidden" name="ontologyId" th:value="${ontology.id}"/>
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
				</form>

				<form role="form" id="ontology_create_form" th:object="${ontology}" method="post" class="form">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
					<input id="schema" class="hidden-validation" type="hidden" name="schema"  th:field="*{schema}" />
					<!-- VERSIONING -->
					<th:block th:include="versioning/fragments/form-commit"></th:block>
					<!-- FORM ACTIONS FOR INSERT-->
					<input th:if="${ontology.id} == null" type="hidden" name="action" th:value="@{/ontologies/createkpi}"/>

					<!-- FORM ACTIONS FOR UPDATE -->
					<input th:if="${ontology?.id} != null" type="hidden" name="action" th:value="@{'/ontologies/updatekpi/'+${ontology.id}}"/>
					<input th:if="${ontology?.id} != null" type="hidden" name="_method" value="PUT"/>

					<div id="header">
						<div class="row pageWizardHeader" th:if="${ontology?.id} == null">
							<div class="wizardContainer col-md-6 col-sm-6 col-xs-12">
								<div id="tab-datos" class="wizard-option active">
									<div class="mt-checkbox-list">
										<label class="mt-checkbox popovers font-sm" data-trigger="hover" data-placement="top" data-container="body">
											<div class="inline font-xs">
												<a href="#tab_1" data-toggle="tab" aria-expanded="false">
													<!-- FORM TITLE -->
													<span class="caption-subject " th:text="#{gen.generalInformation}"> General Information</span><span class="required"> *</span>
												</a>
											</div>
											<input id="stepOneCheckbox" class="form-control no-remove" type="checkbox" disabled="disabled"/>
											<span></span>
										</label>
	    						  	</div>

								</div>
								<div id="tab-kpi-conf" class="wizard-option">
									<div class="mt-checkbox-list">
										<label class="mt-checkbox popovers font-sm" data-trigger="hover" data-placement="top" data-container="body">
											<div class="inline font-xs">
												<a href="#tab_kpi_conf" data-toggle="tab" aria-expanded="true" class="disabled">
													<span class="caption-subject " th:text="#{ontology.kpisettings}"> KPI SETTINGS</span><span class="required"> *</span>
												</a>
											</div>
											<input id="stepTwoCheckbox" class="form-control no-remove" type="checkbox" disabled="disabled"/>
											<span></span>
										</label>
									</div>
								</div>
							</div>
							<div class="col-md-6 col-sm-6 col-xs-12">
								<div class="pull-right">
									<!-- CANCEL -->
									<button th:if="${#strings.arrayJoin(#authentication.authorities,'')} != 'ROLE_ADMINISTRATOR'" id="cancelBtn" type="button" class="btn btn-primary-cancel" name="cancel"  th:value="#{gen.cancelBtn}" value="cancel" th:attr="onclick='javascript:OntologyCreateController.cancel(\'' + ${ontology.id} + '\',\'' + @{/} + '\');'"><span th:text="#{gen.cancelBtn}"> Cancel </span></button>
									<button th:if="${#strings.arrayJoin(#authentication.authorities,'')} == 'ROLE_ADMINISTRATOR'" id="cancelBtn" type="button" class="btn btn-primary-cancel" name="cancel"  th:value="#{gen.cancelBtn}" value="cancel" th:attr="onclick='javascript:OntologyCreateController.cancel(\'' + ${ontology.id} + '\',\'' + @{/ontologies/list} + '\');'"><span th:text="#{gen.cancelBtn}"> Cancel </span></button>

									<!-- RESET -->
									<button id="resetBtnCreate" type="button" class="btn btn-primary-cancel" onclick="location.href='../ontologies/createkpi'" name="reset"  th:value="#{gen.resetBtn}" ><span th:text="#{gen.resetBtn}"> Reset</span></button>


									<!-- CONTINUE -->
									<button id="continueBtn" type="button" class="btn btn-primary btn-primary-save" name="continue"  onclick="OntologyCreateController.wizardContinue()" th:value="#{gen.continueBtn}" disabled="disabled"><span th:text="#{gen.continueBtn}"> Continue</span></button>

									<!-- CREATE -->
									<button id="createWizardBtn" type="submit" class="btn btn-primary btn-primary-save hide" name="create" disabled="disabled"><span th:text="#{gen.createBtn}"> New</span></button>
								</div>
							</div>
						</div>
						<div class="row pageCreateHeader" th:if="${ontology?.id} != null">
							<div class="col-md-6 col-sm-6 col-xs-12">
								<div class="margin-top-4">
									<span th:if="${ontology?.id} == null" th:text="#{ontology.template.create}"> New Ontology</span>
									<span th:if="${ontology?.id} != null" th:text="${ontology.identification}"> Update Ontology </span>
								</div>
							</div>

							<div class="col-md-6 col-sm-6 col-xs-12">
								<div class="pull-right">
									<!-- DELETE -->
									<button sec:authorize="!hasAuthority('ROLE_PARTNER')" id="deleteBtn" type="button" class="btn btn-primary btn-primary-delete" name="delete"  value="Remove" th:attr="onclick='OntologyCreateController.deleteOntology(\'' + ${ontology.id} + '\');'" ><i class="icon-delete"></i><span th:text="#{gen.deleteBtn}" class="delete-btn-text"> Delete </span></button>

									<span class="sep" sec:authorize="!hasAuthority('ROLE_PARTNER')"></span>

									<!-- CANCEL -->
									<button id="cancelBtn" type="button" class="btn btn-primary-cancel" style="border: none !important"  name="cancel"  th:value="#{gen.cancelBtn}" value="cancel" th:attr="onclick='javascript:OntologyCreateController.go(\'' + @{/ontologies/list} + '\');'"><span th:text="#{gen.cancelBtn}"> Cancel </span></button>

									<!-- RESET -->
									<button id="resetBtn" type="button" class="btn btn-outline-search" name="reset"  th:value="#{gen.resetBtn}" disabled="disabled"><span th:text="#{gen.resetBtn}"> Reset</span></button>

									<span class="sep no-border"></span>

									<!-- UPDATE -->
									<button id="updateBtn" type="submit" class="btn btn-primary btn-primary-save" name="update"  onclick="" th:value="#{gen.editBtn}" ><span th:text="#{gen.changes}"> Save Changes</span></button>
								</div>
							</div>
						</div>
					</div>

					<!-- MAIN ROW -->
					<div class="row equal flex-container">
						<div th:class="${ontology.id} == null ? 'tab-content col-md-12 padding-left-48' : 'tab-content flex-content-right'">
							<div class="tab-pane fade in active" id="tab_1">
							<!-- ONTOLOGY FORM -->
								<div class="row main">
									<div class="col-md-9 col-sm-9 col-xs-9 panelHeader">
										<span th:text="#{gen.generalInformation}">General Information</span>
									</div>
									<div class="col-md-3 col-sm-3 col-xs-3">
										<span th:text="#{gen.denotesRequired}" class="denotesRequired">* Denotes Required Field</span>
									</div>
								</div>

								<div class="row main">
									<div class="col-md-12 col-sm-12 col-xs-12">
										<label data-trigger="hover" data-placement="top" data-container="body" th:attr="data-content=#{json2ont.newontology.help},data-title=#{json2ont.newontology.title}">
											<div class="mt-checkbox-list" style="height: 0px; display:inline-block;">
												<div class="switch">
													<label>
														<input id="check-new-ontology" name="newOntology" type="checkbox" class="form-control no-remove" th:checked="checked" ></input>
														<span class="checkbox-slider round" ></span>
													</label>
												</div>
												<div class="inline font-xs" th:text="#{json2ont.newontology.title}" style="margin-left:7px;color:#505D66;"></div>
											</div>
										</label>
									</div>
								</div>
								<div class="row main margin-top-10">
									<div class="col-md-3 col-sm-4 col-xs-12">
										<div style="clear: both;" id="newOntologyDiv" class="hide">
											<div class="form-group">
												<label class="control-label" th:text="#{gen.ontology}">Ontologies</label>
												<select id="ontology" class="selectpicker form-control no-remove" data-live-search="true" data-width="100%" name="id" th:title="#{json2ont.selectont}" onchange="">
													<option th:each="ontology :${ontologies}" th:value="${ontology.identification}" th:text="${ontology.identification}"></option>
												</select>
												<span id="ontologyerror" class="help-block font-red hide" th:text="#{gen.requiredField}"><i class="la la-warning"></i> Required field</span>
											</div>
										</div>
									</div>
								</div>

								<!-- new ontology -->
								<div class="newOntology">
									<div class="row main">
										<div class="col-md-3 col-sm-6 col-xs-12">
											<div class="form-group">
												<label class="" th:text="#{ontology.identification}">Name</label><span class="required"> *</span>
												<input th:tabindex="1" id="name" type="text" th:readonly="*{id}" minlength="5" maxlength="50" th:field="*{name}" class="form-control " th:placeholder="#{ontology.name}" />
												<span id="nameerror" class="help-block font-red hide" th:text="#{ontology.name.error}"><i class="la la-warning"></i></span>
											</div>
										</div>
									</div>
									<div class="row main">
										<div class="col-md-6 col-sm-12 col-xs-12">
											<div class="form-group">
												<label th:text="#{ontology.metainf}" class="popovers font-sm" data-trigger="hover" data-placement="top" data-container="body" th:attr=" data-content=#{ontology.metainf.help},data-title=#{ontology.metainf}">Meta-inf</label><span class="required"> *</span>
												<input data-msg="Please fill this field" th:tabindex="2" id="metainf" name="metainf" data-role="tagsinput"	class="form-control tagsinput" type="text" th:field="*{metainf}" data-minlength="2" pattern=".{2,}" min="2"></input>
												<span id="metainferror" class="help-block font-red hide" th:text="#{ontology.metainf.min}"><i class="la la-warning"></i></span>
											</div>
										</div>
									</div>
									<div class="row main">
										<div class="col-md-6 col-sm-12 col-xs-12">
											<div class="form-group no-margin-bottom">
												<label th:text="#{ontology.description}">Comments</label><span class="required"> *</span>
												<textarea th:tabindex="3" class="element textarea small form-control" id="description" name="description" maxlength="512" th:field="*{description}"  cols="" rows=""></textarea>
												<span id="descriptionerror" class="help-block" th:text="#{ontology.description.min}"><i class="la la-warning"></i></span>
											</div>
										</div>
									</div>
									<div class="row main">
										<div class="col-md-3 col-sm-6 col-xs-12">
										<!-- RTDB SELECTION -->
											<div th:if="${ontology.id == null}" class="form-group no-margin-bottom">
												<label class="control-label" th:text="#{ontology.rtdbinstance}">Rtdb instance</label>
												<select id="datasource" name="datasource" class="selectpicker form-control" data-live-search="true" data-width="100%"  >
													<option th:each="rtdb :${rtdbs}" th:value="${rtdb}" th:text="${rtdb}" ></option>
												</select>
											</div>
										</div>
									</div>
									<div class="row main">
										<div class="col-md-3 col-sm-6 col-xs-6">
											<label class="control-label" style="background: #FFFDFA; border: 1px solid #E79E38; border-radius: 2px; padding: 8px 12px 8px 4px;">
												<i class="icon-exclamation" style="vertical-align: bottom;"></i><span th:text="#{ontology.rtdb.warning}" >Warning</span>
											</label>
										</div>
									</div>
									<div class="row main">
										<div class="col-md-12 col-sm-12 col-xs-12">
											<label class="control-label" th:text="#{gen.options}">Options</label>
										</div>
										<div class="col-md-12 col-xs-12" sec:authorize="!@securityService.hasAnyRole('ROLE_PARTNER')">
											<input id="active" class="margin-right-10" name="active" type="checkbox" checked="checked" th:field="*{active}" />
											<label class="control-label margin-right-5" th:text="#{ontology.activeontology}">Active</label>
											<i class="la la-info-circle popovers" data-trigger="hover" data-placement="top" data-container="body" th:attr="data-content=#{ontology.active.help},data-title=#{ontology.active}"></i>
										</div>
										<div class="col-md-12 col-xs-12">
											<input id="public" class="margin-right-10" name="public" type="checkbox" checked="checked" th:field="*{public}" />
											<label class="control-label margin-right-5" th:text="#{ontology.publicontology}">Public</label>
											<i class="la la-info-circle popovers"  data-trigger="hover" data-placement="top" data-container="body" th:attr="data-content=#{ontology.public.help},data-title=#{ontology.public}"></i>
										</div>
										<div class="col-md-12 col-xs-12">
											<input id="allowsCypherFields" class="margin-right-10" name="allowsCypherFields" type="checkbox" checked="checked" th:field="*{allowsCypherFields}" />
											<label class="control-label margin-right-5" th:text="#{ontology.allowsCypherFields}">Allows Cypher</label>
											<i class="la la-info-circle popovers"  data-trigger="hover" data-placement="top" data-container="body" th:attr="data-content=#{ontology.allowsCypherFields.help},data-title=#{ontology.allowsCypherFields}"></i>
										</div>
										<div class="col-md-12 col-xs-12">
											<input id="contextDataEnabled" class="margin-right-10" name="contextDataEnabled" type="checkbox" checked="checked" th:field="*{contextDataEnabled}" />
											<label class="control-label margin-right-5" th:text="#{ontology.contextDataEnabled}">ContextData</label>
										    <i class="la la-info-circle popovers"  data-trigger="hover" data-placement="top" data-container="body" th:attr="data-content=#{ontology.contextDataEnabled.help},data-title=#{ontology.contextDataEnabled}"></i>
                                        </div>
                                        <div class="col-md-2 col-xs-12">
                                            <input id="supportsJsonLd" class="margin-right-10" name="supportsJsonLd" type="checkbox" checked="checked" th:field="*{supportsJsonLd}" />
                                            <label class="control-label margin-right-5" th:text="#{ontology.supportsJsonLd}">Supports JSON-LD</label>
                                            <i class="la la-info-circle popovers"  data-trigger="hover" data-placement="top" data-container="body" th:attr="data-content=#{ontology.supportsJsonLd.help},data-title=#{ontology.supportsJsonLd}"></i>
                                        </div>
                                        <div class="col-md-4 col-xs-12">
                                            <div class="form-group hide" id="jsonLdCtxt">
                                                <label class="control-label" th:text="#{ontology.jsonLdContext}">JSON-LD Context </label><span class="required"> *</span>
                                                <textarea class="form-control" style="height: 100px" id="jsonLdContext" th:field="*{jsonLdContext}" th:required="true" ></textarea>
                                            </div>
                                        </div>	
									</div>
								</div>
							</div>

							<div class="tab-pane" id="tab_kpi_conf">
								<div class="row main">
									<div class="col-md-9 col-sm-9 col-xs-9 panelHeader">
										<span th:text="#{ontology.kpisettings}">KPI Settings</span>
									</div>
									<div class="col-md-3 col-sm-3 col-xs-3">
										<span th:text="#{gen.denotesRequired}" class="denotesRequired">* Denotes Required Field</span>
									</div>
								</div>
								<div class="row main">
									<div class="col-md-3 col-sm-4 col-xs-6">
										<label class="control-label" th:text="#{ontology.kpi.cron}">CRON</label><span class="required"> *</span>
										<div class="input-group date">
											<input th:tabindex="1" readonly="true" id="cron" name="cron" type="text" maxlength="50" th:field="*{cron}" class="form-control " th:placeholder="#{ontology.kpi.cron}" />
											<div class="input-group-addon" data-toggle="modal" data-target="#dialog-cron"   data-container="body" data-placement="top" >
												<span  class="la la-clock-o"> </span>
											</div>
										</div>
										<span id="cronerror" class="help-block help-block-error font-red hide">This field is required.</span>
									</div>
									<div class="col-md-3 col-sm-4 col-xs-6">
										<label class="control-label" th:text="#{ontology.kpi.date.from.to}">ACTIVATED FROM </label>
										<div style="display: inline-flex;">
											<div class="input-group date" data-provide="datepicker">
												<input type="text" name="dateFrom" class="form-control"	th:field="*{dateFrom}" />
												<div class="input-group-addon">
													<span class="la la-clock-o"></span>
												</div>
											</div>
											<div class="input-group date" data-provide="datepicker">
												<input type="text" name="dateTo" class="form-control" th:field="*{dateTo}" />
												<div class="input-group-addon">
													<span class="la la-clock-o"></span>
												</div>
											</div>
										</div>
									</div>
								</div>

								<div class="row main">
									<div class="col-md-9 col-sm-7 col-xs-3">
										<label class="control-label" th:text="#{ontology.kpi.query}">QUERY</label><span class="required"> *</span>
									</div>
									<div class="col-md-3 col-sm-5 col-xs-9">
										<button type="button" class="btn btn-primary btn-primary-save margin-left-10 pull-right" onclick="getQueryExecutedFragment()" id="executeQuery"><span th:text="#{database.execQuery}">Execute Query</span></button>
										<button type="button" id="toggle-button" class="btn btn-primary btn-primary-save btn-table-toggle pull-right hide" ><span th:text="#{gen.tableViewToggle}">Table Viewer Toggle</span></button>
									</div>
								</div>
								<div class="row main">
									<div class="col-md-12 col-sm-12 col-xs-12">
										<div class="form-group" id="queryeditor">
											<textarea th:tabindex="4" rows="7" class="form-control" id="query" name="query" th:field="*{query}" cols="" ></textarea>
											<span id="queryerror" class="help-block help-block-error font-red hide">This field is required.</span>
										</div>
									</div>
								</div>
								<div class="row main">
									<!-- PANEL DE RESULTADOS -->
									<div class="panel panel-white no-shadow">
										<div id="result-panel" class="panel-body no-space hide">
											<!-- RESPUESTA DE CONSULTA -->
											<div class="col-md-12">
												<div class="hide" id="Canvasrespuesta">
													<div id="theQueryResponse" th:fragment="query" th:text="${queryResult}"></div>
												</div>
												<div id="jsoneditor" data-loaded="false" style="height: 300px"></div>
												<div class="table-viewer" style="display: none;" data-loaded="false"></div>
												<div class="clearfix"></div>
											</div>
											<div id="example" class="col-md-12">
											</div>
						                    <div id="dialog-confirm-generic" title="Información" style="display: none;">
					                            <div>Información</div>
						                    </div>
										</div>
									</div>
								</div>

								<div class="row main">
									<div class="col-md-12 col-sm-12 col-xs-12 ">
										<div class="switch">
											<label>
												<input id="postProcessCheckbox" type="checkbox" class="form-control" onclick="loadCodeMirror()"/>
												<span class="checkbox-slider round"></span>
											</label>
										</div>
										<div class="inline font-xs margin-left-10 description" th:text="#{ontology.kpi.postProcess.checkbox}">Postprocesss</div>
									</div>
									<div class="col-md-12 col-sm-12 col-xs-12">
										<div id="portletBody" class="portlet-body" style="display: none; height: auto;">
											<div class="form-group">
												<textarea id="postProcess" name="postProcess"  th:field="*{postProcess}" class="form-control"></textarea>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</form>
				<!-- MODAL LD -->
				<div th:include="fragments/ontology-create-ld-modal">
				</div>
				<!-- Modal -->
				<div id="modal-created" class="modal fade" role="dialog">
					<div class="modal-dialog modal-sm">
						<!-- Modal content-->
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" th:attr="onclick='javascript:navigateUrl(\'' + @{/ontologies/list} +'\');'" data-dismiss="modal"></button>
								<h4 class="modal-title" th:text="#{json2ont.ontcreated}"></h4>
							</div>
							<div class="modal-body">
						      	<h4 ><a target="_blank" th:text="#{ontology.after.create.api}" th:attr="onclick='javascript:navigateUrl(\'' + @{/apimanager/create} +'?id=\'+$(\'#identification\').val()'+');'">Create API</a></h4>
						      	<h4 ><a target="_blank" th:text="#{ontology.after.create.device}" th:attr="onclick='javascript:navigateUrl(\'' + @{/devices/create} +'?id=\'+$(\'#identification\').val()'+');'">Create Device</a></h4>
					      		<h4 ><a target="_blank" th:text="#{ontology.after.create.dashboard}" th:attr="onclick='javascript:navigateUrl(\'' + @{/dashboards/create} +'?id=\'+$(\'#identification\').val()'+');'">Create Dashboard</a></h4>
					      		<h4 ><a target="_blank" th:text="#{ontology.after.create.gadget}" th:attr="onclick='javascript:navigateUrl(\'' + @{/gadgets/create} +'?id=\'+$(\'#identification\').val()'+');'">Create Gadget</a></h4>

					      	</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-default" th:attr="onclick='javascript:navigateUrl(\'' + @{/ontologies/list} + '\');'" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
			</div><!-- END COL-12 -->

			<!-- MODAL INFO ARRAYS AND OBJECTS -->
		    <div id="modal-info-objects" class="modal fade" role="dialog">
				<div class="modal-dialog">

				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"></button>
						<h4 class="modal-title" id="response">INFO</h4>
					</div>
					<div class="modal-body" style="text-align: center">
						<p>You have selected properties of type Object and/or Array.</p>
						<p id="complex-properties"></p>
						<p>Please take into account that these properties must be completed from the JSON raw editor</p>
			      	</div>
			      	<div class="modal-footer">
			        	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			    	</div>
				</div>
			</div>
		</div>
	</div><!-- END CONTENT page-content-wrapper -->

	<!-- FOOTER INCLUDE -->
	<footer th:include="fragments/footer::#footerFragment" class="page-footer"> </footer>

	<!-- Modal -->
	<div id="jsonModal" class="modal fade" role="dialog">
		<div class="modal-dialog">

			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title"><span th:text="#{gen.json}">JSON value for </span> <span id="jsonDatatTitle" class="bold"></span> </h4>
				</div>
				<div class="modal-body">
					<pre id="jsonDataView"></pre>
				</div>
				<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> <span th:text="#{gen.closeBtn}">Close</span></button>
				</div>
			</div>

		</div>
	</div>




	<!-- CORE JS CONTROLLERS -->
	<script th:src="@{/static/js/app.js}"></script>
	<script th:src="@{/static/js/layout.js}"></script>
	<script th:src="@{/static/js/utils/genericFunctions.js}"></script>
	<!-- UTILS -->
	<script th:src="@{/static/js/utils/schemaGen.js}"></script>
	<!-- PLUGINS -->
	<script th:src="@{/static/vendor/bootstrap-select/bootstrap-select.min.js}"></script>
	<script th:src="@{/static/vendor/bootstrap-datepicker/bootstrap-datepicker.min.js}"></script>
	<script th:src="@{/static/vendor/jquery/jquery.dataTables.min.js}"></script>
	<script th:src="@{/static/vendor/datatable/datatables.bootstrap.js}"></script>
	<script th:src="@{/static/vendor/codemirror/lib/codemirror.js}"></script>
	<script th:src="@{/static/vendor/codemirror/mode/javascript/javascript.js}" ></script>
	<script th:src="@{/static/vendor/codemirror/addon/edit/matchbrackets.js}" ></script>
	<script th:src="@{/static/vendor/codemirror/addon/edit/closebrackets.js}" ></script>
	<script th:src="@{/static/vendor/codemirror/addon/selection/active-line.js}" ></script>
	<script th:src="@{/static/vendor/codemirror/addon/comment/comment.js}" ></script>
	<script th:src="@{/static/vendor/codemirror/addon/comment/continuecomment.js}" ></script>


	<!-- LOADING DEFAULT DATES IF NEEDED -->
	<script th:if="${lang} == 'es'" th:src="@{/static/vendor/bootstrap-datepicker/locales/bootstrap-datepicker.es.min.js}" type="text/javascript"></script>

	<script th:src="@{/static/vendor/jquery-validation/jquery.validate.min.js}" type="text/javascript"></script>
    <script th:src="@{/static/vendor/jquery-validation/additional-methods.min.js}" type="text/javascript"></script>
    <script th:src="@{/static/vendor/jquery-form/jquery.form.min.js}" type="text/javascript"></script>
	<!-- LOADING DEFAULT LANG MESSAGES IF NEEDED -->
	<script th:if="${lang} == 'es'" th:src="@{/static/vendor/jquery-validation/localization/messages_es.min.js}" type="text/javascript"></script>

	<script th:src="@{/static/vendor/bootstrap-tagsinput/bootstrap-tagsinput.min.js}" type="text/javascript"></script>
	<script th:src="@{/static/vendor/json/mountable.min.js}" type="text/javascript"></script>

	<!-- JSON EDITOR -->
	<script th:src="@{/static/vendor/json/json2.min.js}"></script>
	<script th:src="@{/static/vendor/json/jsoneditor.js}"></script>
	<script th:src="@{/static/vendor/ace/ace.js}" charset="utf-8"></script>
	<script th:src="@{/static/vendor/ace/mode-json.js}"></script>
	<script th:src="@{/static/vendor/ace/theme-textmate.js}"></script>
	<script th:src="@{/static/vendor/json/jsonToTable.js}"></script>
    
        <!-- CODEMIRROR -->
    <script th:src="@{/static/vendor/jquery/jquery.dataTables.min.js}"></script>
    <script th:src="@{/static/vendor/datatable/datatables.bootstrap.js}"></script>  
    <script th:src="@{/static/vendor/jquery/jquery.autocomplete.js}"></script>
    <script th:src="@{/static/vendor/bootstrap-datepicker/bootstrap-datepicker.min.js}"></script>
    <script th:src="@{/static/vendor/codemirror/lib/codemirror.js}"></script>
    <script th:src="@{/static/vendor/codemirror/mode/javascript/javascript.js}" ></script>
    <script th:src="@{/static/vendor/codemirror/mode/sql/sql.js}" ></script>
    <script th:src="@{/static/vendor/codemirror/addon/edit/matchbrackets.js}" ></script>
    <script th:src="@{/static/vendor/codemirror/addon/edit/closebrackets.js}" ></script>
    <script th:src="@{/static/vendor/codemirror/addon/selection/active-line.js}" ></script>
    <script th:src="@{/static/vendor/codemirror/addon/comment/comment.js}" ></script>
    <script th:src="@{/static/vendor/codemirror/addon/comment/continuecomment.js}" ></script>
    

	<!-- INPUTMASK -->
	<script th:src="@{/static/vendor/jquery-inputmask/dist/min/jquery.inputmask.bundle.min.js}"></script>


	<!-- TEMPLATE CONTROLLER  -->
	<script th:src="@{/static/js/pages/ontologyCreateKPI.js}"></script>

	<!-- MAIN INIT -->
	<script  th:inline="javascript">
	//<![CDATA[
	function navigateUrl(url){  window.location.href = url;	}
	$(function () {
		  $('[data-toggle="tooltip"]').tooltip()
		})
	var currentLanguage = [[${lang}]];
	var ontologyCreateJson = {
		"close" : [[#{gen.closeBtn}]],
		"language" : currentLanguage,
		"actionMode" : [[${ontology?.id}]],
		"schemaEditMode" : [[${ontology?.schema}]],
		"datamodel": [[#{ontology.datamodel}]],
		"ontologyId": [[${ontology?.id}]],
		"authorizations" : [[${authorizations}]],
		"confirmBtn" : [[#{gen.confirmBtn}]],
		"removeBtn" : [[#{gen.deleteBtn}]],
		"addpropertyBtn" : [[#{ontology.addproperty}]],
		"updateSchemaBtn" : [[#{ontology.updateschema}]],
		"executeQuery" : [[#{ontology.kpi.executeQuery}]],
		"validations" : {
			"duplicates": [[#{ontology.valid.duplicates}]],
			"tplschema": [[#{ontology.valid.tplschema}]],
			"noschema": [[#{ontology.valid.noschema}]],
			"authinsert": [[#{ontology.valid.authinsert}]],
			"validform": [[#{ontology.validform}]],
			"schemaprop": [[#{ontology.valid.schemaprop}]],
			"schemanoprop": [[#{ontology.valid.schemanoprop}]],
			"nonode": [[#{ontology.valid.nonode}]],
			"norequired": [[#{ontology.valid.norequired}]],
			"noproperties": [[#{ontology.valid.noproperties}]],
			"base": [[#{ontology.valid.base}]],
			"authuser": [[#{ontology.valid.auths.user}]],
			"noinstances": [[#{ontology.valid.noinstances}]],
			"datamodelchange" : [[#{ontology.confirm.datamodel}]],
			"invalidQuery" : [[#{ontology.valid.query.error}]],
			"invalidSchema" : [[#{ontology.valid.schema}]],
			"greaterthan" : [[#{gen.greaterthan}]],
			"jsonldformat": [[#{ontology.valid.jsonldformat}]]
		}
	};
	// LOAD DATA TO USE IN CREATE WIZARD CONTROLLER
	// CREATE WIZARD CONTROLLER LOAD AND INIT ITSELF

		var showLog = 1; // global var control console messages
		var valueObjects = [];
		var queryResponse = {};
		var queryErrorResponse = {};
		var dataJSON = {};
		var myCodeMirrorJs;
		var myCodeMirrorQueryJs;

	function getQueryExecutedFragment() {

			var testOntology = GenericFunctions.getOntologyFromQuery(myCodeMirrorQueryJs.getValue());
			var csrf_value = $("meta[name='_csrf']").attr("content");
			var csrf_header = $("meta[name='_csrf_header']").attr("content");

			$.ajaxSetup({'headers': {
				[csrf_header]: csrf_value
		    }});

			$("#Canvasrespuesta").load('/controlpanel/ontologies/queryKPI', { 'query': myCodeMirrorQueryJs.getValue(), 'queryType':'SQL', 'ontologyIdentification': testOntology},function(response,status,xhr){

				queryResponse = $(response);

				// check for valid json, or server string error like java.lang.Exception...
				var IS_JSON = true;
				try{ var json = $.parseJSON(queryResponse.text());	} catch(err){ IS_JSON = false; }

				if (!IS_JSON){
					var text=""+queryResponse.text();
					// Our own JSON string to mark non JSON ERRORs
					queryErrorResponse = text;
				}

				if ($('#jsoneditor').attr('data-loaded') == 'false') { createEditor(); $('#jsoneditor').attr('data-loaded', true);	}
				if (IS_JSON) {
					dataJSON = queryResponse.text();
					editor.setText(queryResponse.text());
					editor.setMode('view');
					if ($('.table-viewer').is(':visible')){ $('.btn-table-toggle').trigger('click'); } }else { editor.setMode('text');  editor.setText(queryErrorResponse); }

			});


			$('#query-ontologia-result').text('' + $('#selector_ontologias').val());
			if ($('#result-panel').hasClass('hide')){ $('#result-panel').toggleClass('hide'); }
			if ($('#toggle-button').hasClass('hide')){ $('#toggle-button').toggleClass('hide'); }
		}





	// CREATE EDITOR FOR JSON SCHEMA
	var createEditor = function(){

		showLog ? console.log('|--->   createEditor()') : '';
		var container = document.getElementById('jsoneditor');
		var options = {
			mode: 'text',
			theme: 'bootstrap3',
			required_by_default: true,
			modes: ['text', 'tree', 'view'], // allowed modes
			error: function (err) {
				$.alert({title: 'ERROR!', theme: 'light', style: 'red', content: err.toString()});
				return false;
			},
			onChange: function(){

				console.log('se modifica el editor en modo:' + editor.mode + ' contenido: ' + editor.getText());
			}
		};

		editor = new jsoneditor.JSONEditor(container, options, "");

	}

	function showData(key,str){
		$('#jsonDatatTitle').text(str);
		// WALK THE ARRAY AND RETURN .JSON PROPERTY OF THE OBJECT WICH KEY IS THE KEY I WANT TO FIND.
		var str = valueObjects.find(x => x.key === key).json;
		if (str === 'null') { return false; }
		jsonToModal = syntaxHighlight(str);
		document.getElementById("jsonDataView").innerHTML = jsonToModal;
		$('#jsonModal').modal();

	};
	function syntaxHighlight(json) {
		json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
			var cls = 'number';
			if (/^"/.test(match)) {
				if (/:$/.test(match)) {
					cls = 'key';
				} else {
					cls = 'string';
				}
			} else if (/true|false/.test(match)) {
				cls = 'boolean';
			} else if (/null/.test(match)) {
				cls = 'null';
			}
			return '<span class="' + cls + '">' + match + '</span>';
		});
	};

	function openCronDialog(){
	  		showCronDialog();
	}

	function handleCodeMirror() {
		myTextArea = document.getElementById('postProcess');
		myCodeMirrorJs = CodeMirror.fromTextArea(myTextArea, {
	    	mode: "text/javascript",
	    	autoRefresh: true,
	    	autoCloseBrackets: true,
	        matchBrackets: true,
	        styleActiveLine: true,
	        theme:"material",
	        lineWrapping: true
	    });
		myCodeMirrorJs.setSize("100%",200);

		myTextAreaQuery = document.getElementById('query');
		myCodeMirrorQueryJs = CodeMirror.fromTextArea(myTextAreaQuery, {
	    	mode: "text/javascript",
	    	autoRefresh: true,
	    	autoCloseBrackets: true,
	        matchBrackets: true,
	        styleActiveLine: true,
	        theme:"material",
	        lineWrapping: true
	    });
		myCodeMirrorQueryJs.setSize("100%",100);
	}

	function loadCodeMirror(){
		var defaultExample = "// data is a string variable containing the query output \nvar dataArray = JSON.parse(data);\n\n// A string result must be returned\nreturn (JSON.stringify(dataArray));";
		if ($('#postProcessCheckbox').is(':checked')) {
			myCodeMirrorJs.setValue(defaultExample);
			$('#postProcess').val(myCodeMirrorJs.getValue());
			setTimeout(function() {
				myCodeMirrorJs.refresh();
			},1);
			$('#portletBody').css("display","inline");
		} else {
			myCodeMirrorJs.setValue("");
			$('#postProcess').val(myCodeMirrorJs.getValue());
			setTimeout(function() {
				myCodeMirrorJs.refresh();
			},1);
			$('#portletBody').css("display","none");
		}
	}

	$(document).ready(function(){
		handleCodeMirror();
		$('.btn-table-toggle').on('click',function(){

			if (editor){
				if ($('.table-viewer').is(':visible')){
					$('#jsoneditor').fadeIn();
					$('.table-viewer').fadeOut();
				}
				else{
				$('#jsoneditor').fadeOut();
				$('.table-viewer').createTable(JSON.parse(dataJSON), {});
				$('.table-viewer').fadeIn();

				}
			}
			else { return; }


		});
		$("#name").inputmask({ regex: "[a-zA-Z0-9_]*", greedy: false });
	});

	$("#stepOneCheckbox").click(function() { return false; });
	$("#stepTwoCheckbox").click(function() { return false; });
	//]]>
	</script>

</body>
</html>
